<wdkModel>
    <querySet name="GeneSummaries">

     <!-- notes

       - all projects need a gene alias query (or, we have to break that out of the 
         <recordClass> element

     -->

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Gene alias -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="AnyInstances" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT source_id, project_id
                    FROM $$gene_answer$$
                    WHERE $$gene_answer.condition$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ToxoGenes" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT c.*
                 FROM   
                    (SELECT source_id, project_id
                      FROM $$gene_answer$$
                      WHERE $$gene_answer.condition$$) c,
                    (SELECT  MAX(c.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ans, apidb.geneattributes ga
                      WHERE $$gene_answer.condition$$
                      AND ga.source_id = ans.source_id
                      GROUP BY ga.gene_id) f
                WHERE c.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="AllInstances" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
        <!-- this sql needs some work ... not very tight as could have two instances from one starain and 1 from second and return that gene -->
                <![CDATA[
                 SELECT c.*
                 FROM   
                    (SELECT source_id, project_id
                      FROM $$gene_answer$$
                      WHERE $$gene_answer.condition$$) c,
                    (SELECT  MAX(c.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ans, apidb.geneattributes ga
                      WHERE $$gene_answer.condition$$
                      AND ga.source_id = ans.source_id
                      GROUP BY ga.gene_id having count(*) >= 3) f
                WHERE c.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="GT1Instances" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ans.source_id, ans.project_id
                    FROM $$gene_answer$$ ans, apidb.geneattributes ga
                    WHERE $$gene_answer.condition$$
                    AND ga.source_id = ans.source_id
                    AND ga.organism = 'Toxoplasma gondii GT1'
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ME49Instances" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ans.source_id, ans.project_id
                    FROM $$gene_answer$$ ans, apidb.geneattributes ga
                    WHERE $$gene_answer.condition$$
                    AND ga.source_id = ans.source_id
                    AND ga.organism = 'Toxoplasma gondii ME49'
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="VEGInstances" isCacheable="false">
            <paramRef ref="recordParams.strain_summary"/>
            <paramRef ref="recordParams.instance_gene"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ans.source_id, ans.project_id
                    FROM $$gene_answer$$ ans, apidb.geneattributes ga
                    WHERE $$gene_answer.condition$$
                    AND ga.source_id = ans.source_id
                    AND ga.organism = 'Toxoplasma gondii VEG'
                ]]>
            </sql>
        </sqlQuery>

    </querySet>

</wdkModel>
