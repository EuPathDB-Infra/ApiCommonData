<wdkModel>
    <querySet name="GeneSummaries" queryType="summary">

     <!-- notes

       - all projects need a gene alias query (or, we have to break that out of the 
         <recordClass> element

     -->

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Gene strains summary-->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="AllResults" isCacheable="false" includeProjects="ToxoDB,GiardiaDB">
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT source_id, project_id
                    FROM $$gene_answer$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="DeprecatedGenes" isCacheable="false" includeProjects="GiardiaDB">
            <paramRef ref="recordParams.deprecated_genes"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT c.source_id, c.project_id
                    FROM $$gene_answer$$ c, apidb.geneattributes ga
                    where ga.source_id = c.source_id
                    and ga.is_deprecated = $$deprecated_genes$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="BooleanExpansion" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT gb.source_id, gb.project_id
                    FROM $$gene_answer$$ c, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = c.source_id
                    AND gb.gene_id = ga.gene_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ToxoGenes" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.organism"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT c.*
                 FROM   
                    (SELECT source_id, project_id
                      FROM $$gene_answer$$ ) c,
                    (SELECT  MAX(ga.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ca, apidb.geneattributes ga
                      WHERE ga.source_id = ca.source_id
                      AND ga.organism like $$organism$$
                      GROUP BY ga.gene_id) f
                WHERE c.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="NeosporaGenes" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.organism"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ga.source_id, ga.project_id
                      FROM $$gene_answer$$ ca, apidb.geneattributes ga
                      WHERE ga.source_id = ca.source_id
                      AND ga.organism = $$organism$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="AllTgResults" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.organism"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ga.source_id, ga.project_id
                      FROM $$gene_answer$$ ca, apidb.geneattributes ga
                      WHERE ga.source_id = ca.source_id
                      AND ga.organism like $$organism$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="OneToOneToOneTgGenes" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
select source_id,'@PROJECT_ID@' as project_id
from 
(SELECT  MAX(i.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(i.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM 
                      (select gb.gene_id,gb.project_id,gb.organism,min(gb.source_id) as source_id
from  $$gene_answer$$ c, apidb.GENEATTRIBUTES ga, apidb.GENEATTRIBUTES gb
where c.source_id = ga.SOURCE_ID
and ga.ORGANISM = 'Toxoplasma gondii ME49'
and ga.gene_id = gb.gene_id
and gb.organism = 'Toxoplasma gondii ME49'
group by gb.gene_id,gb.PROJECT_ID,gb.organism having count(*) = 1
UNION
select gb.gene_id,gb.project_id,gb.organism,min(gb.source_id) as source_id
from  $$gene_answer$$ c, apidb.GENEATTRIBUTES ga, apidb.GENEATTRIBUTES gb
where c.source_id = ga.SOURCE_ID
and ga.ORGANISM = 'Toxoplasma gondii GT1'
and ga.gene_id = gb.gene_id
and gb.organism = 'Toxoplasma gondii GT1'
group by gb.gene_id,gb.PROJECT_ID,gb.organism having count(*) = 1
UNION
select gb.gene_id,gb.project_id,gb.organism,min(gb.source_id) as source_id
from  $$gene_answer$$ c, apidb.GENEATTRIBUTES ga, apidb.GENEATTRIBUTES gb
where c.source_id = ga.SOURCE_ID
and ga.ORGANISM = 'Toxoplasma gondii VEG'
and ga.gene_id = gb.gene_id
and gb.organism = 'Toxoplasma gondii VEG'
group by gb.gene_id,gb.PROJECT_ID,gb.organism having count(*) = 1) i
                      GROUP BY i.gene_id having count(*) = 3)
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="StrainInstances" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT ga.source_id, ga.project_id
                    FROM $$gene_answer$$ ca, apidb.geneattributes ga
                    WHERE ga.source_id = ca.source_id
                    AND ga.organism = $$strain_a$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="TgStrainGenes" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT c.*
                 FROM   
                    (SELECT source_id, project_id
                      FROM $$gene_answer$$ ) c,
                    (SELECT  MAX(ga.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ca, apidb.geneattributes ga
                      WHERE ga.source_id = ca.source_id
                      AND ga.organism like $$strain_a$$
                      GROUP BY ga.gene_id) f
                WHERE c.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="DetailsTgStrainIntersect" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.strain_b"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT source_id,'@PROJECT_ID@' as project_id
                 FROM   
                    (SELECT  MAX(d.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(d.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM 
                  (SELECT c.source_id, c.project_id,c.organism,c.gene_id
                  FROM $$gene_answer$$ ca, 
                    (SELECT gb.source_id, gb.project_id, ga.organism,ga.gene_id
                    FROM $$gene_answer$$ cb, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cb.source_id
                    AND ga.organism = $$strain_a$$
                    AND gb.gene_id = ga.gene_id
                      INTERSECT
                    SELECT gb.source_id, gb.project_id, gb.organism,gb.gene_id
                    FROM $$gene_answer$$ cc, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cc.source_id
                    AND ga.organism = $$strain_b$$
                    AND gb.gene_id = ga.gene_id ) c
                  WHERE c.source_id = ca.source_id
                  AND c.organism = $$strain_a$$ ) d
                group by d.gene_id)
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="DetailsTgStrainMinus" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.strain_b"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT source_id,'@PROJECT_ID@' as project_id
                 FROM   
                    (SELECT  MAX(d.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(d.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM 
                  (SELECT c.source_id, c.project_id,c.organism, c.gene_id
                  FROM $$gene_answer$$ ca, (
                    SELECT gb.source_id, gb.project_id, gb.organism, gb.gene_id
                    FROM $$gene_answer$$ cb, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cb.source_id
                    AND ga.organism = $$strain_a$$
                    AND gb.gene_id = ga.gene_id
                     MINUS
                    SELECT gb.source_id, gb.project_id, gb.organism, gb.gene_id
                    FROM $$gene_answer$$ cc, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cc.source_id
                    AND ga.organism = $$strain_b$$
                    AND gb.gene_id = ga.gene_id ) c
                  WHERE c.source_id = ca.source_id
                  AND c.organism = $$strain_a$$) d
                  GROUP BY d.gene_id)
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="DetailsTgAllMinus" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT d.*
                 FROM   
                    (SELECT  MAX(ga.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ci, apidb.geneattributes ga
                      WHERE ga.source_id = ci.source_id
                      GROUP BY ga.gene_id) f,
                  (SELECT c.source_id, c.project_id
                  FROM $$gene_answer$$ ca, (
                    SELECT gb.source_id, gb.project_id, gb.organism
                    FROM $$gene_answer$$ cb, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cb.source_id
                    AND ga.organism like 'Toxoplasma%'
                    AND gb.gene_id = ga.gene_id
                     MINUS
                    SELECT gb.source_id, gb.project_id, gb.organism
                    FROM $$gene_answer$$ cc, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cc.source_id
                    AND ga.organism = $$strain_a$$
                    AND gb.gene_id = ga.gene_id ) c
                  WHERE c.source_id = ca.source_id) d
                WHERE d.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="DetailsTgAllIntersect" isCacheable="false" includeProjects="ToxoDB">
            <paramRef ref="recordParams.strain_a"/>
            <paramRef ref="recordParams.gene_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                 SELECT d.*
                 FROM   
                    (SELECT  MAX(ga.source_id) KEEP (DENSE_RANK FIRST ORDER BY 
                            DECODE(ga.organism, 'Toxoplasma gondii ME49', 1, 
                                                'Toxoplasma gondii GT1', 2,
                                                'Toxoplasma gondii VEG', 3)) AS source_id
                      FROM $$gene_answer$$ ci, apidb.geneattributes ga
                      WHERE ga.source_id = ci.source_id
                      GROUP BY ga.gene_id) f,
                  (SELECT c.source_id, c.project_id
                  FROM $$gene_answer$$ ca, (
                    SELECT gb.source_id, gb.project_id, gb.organism
                    FROM $$gene_answer$$ cb, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cb.source_id
                    AND gb.gene_id = ga.gene_id
                     INTERSECT
                    SELECT gb.source_id, gb.project_id, gb.organism
                    FROM $$gene_answer$$ cc, apidb.geneattributes ga, apidb.geneattributes gb
                    WHERE ga.source_id = cc.source_id
                    AND ga.organism = $$strain_a$$
                    AND gb.gene_id = ga.gene_id ) c
                  WHERE c.source_id = ca.source_id) d
                WHERE d.source_id = f.source_id
                ]]>
            </sql>
        </sqlQuery>

    </querySet>

</wdkModel>
