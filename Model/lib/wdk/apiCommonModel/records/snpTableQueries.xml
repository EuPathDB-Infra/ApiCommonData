<wdkModel>
    <querySet name="SnpTables" includeProjects="ToxoDB,PlasmoDB">

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Strains -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="Strains" includeProjects="ToxoDB,PlasmoDB" 
              isCacheable="false">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="strain"/>
            <column name="allele"/>
            <column name="allele_gene_strand"/>
            <column name="phenotype"/>
            <column name="product"/>
            <sql>
            <![CDATA[
       SELECT    var.strain, var.allele,
                 CASE WHEN gene_info.is_reversed = 1 THEN apidb.reverse_complement(var.allele) 
                      WHEN gene_info.source_id is null THEN ''
                      ELSE var.allele END as allele_gene_strand,
                 var.phenotype,
                 var.product
       FROM  dots.SnpFeature snp,
             dots.SeqVariation var,
             (select gene.source_id, gene_loc.is_reversed, gene.na_feature_id
               FROM dots.GeneFeature gene, dots.NaLocation gene_loc
               WHERE gene.na_feature_id = gene_loc.na_feature_id) gene_info
       WHERE snp.source_id = $$primaryKey$$
        AND  var.parent_id = snp.na_feature_id
        AND gene_info.na_feature_id(+) = snp.parent_id
        ORDER BY var.strain
             ]]>
           </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Providers -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="Providers" includeProjects="ToxoDB,PlasmoDB" 
               isCacheable="false">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="source_id_link"/>
            <column name="name"/>
            <sqlParamValue name="name" includeProjects="PlasmoDB">
                DECODE(ed.name,'Broad SNPs','Broad','Sanger falciparum SNPs','WTSI','Su SNPs','NIH', 'PlasmoDB combined SNPs', 'PlasmoDB','Sanger reichenowi SNPs','WTSI')
            </sqlParamValue>
            <sqlParamValue name="name" includeProjects="ToxoDB">
                      ed.name
            </sqlParamValue>
            <sqlParamValue name="filter" includeProjects="PlasmoDB">
                and sb.source_id != $$primaryKey$$
            </sqlParamValue>
            <sqlParamValue name="filter" includeProjects="ToxoDB">
            </sqlParamValue>

            <sql>
            <![CDATA[
               SELECT sb.source_id as source_id_link,
               &&name&& as name
               FROM  dots.SnpFeature sa, dots.snpfeature sb, dots.nalocation la, dots.nalocation lb,
                     sres.externaldatabase ed, sres.externaldatabaserelease edr
               WHERE sa.source_id = $$primaryKey$$
                AND sa.na_feature_id = la.na_feature_id
                and sb.na_feature_id = lb.na_feature_id
                and sa.na_sequence_id = sb.na_sequence_id
                and la.start_min = lb.start_min
                &&filter&&
                and sb.external_database_release_id = edr.external_database_release_id
                and edr.external_database_id = ed.external_database_id
             ]]>
           </sql>
        </sqlQuery>

    </querySet>
</wdkModel>
