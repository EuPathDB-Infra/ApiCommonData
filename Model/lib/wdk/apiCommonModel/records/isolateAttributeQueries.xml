<wdkModel>
    <querySet name="IsolateAttributes">

        <sqlQuery name="Barcode" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="project_id"/>
            <column name="strain"/> 
            <column name="country"/> 
            <column name="collected_by"/> 
            <column name="note"/> 
            <column name="sequence"/> 
            <column name="na_sequence_id"/> 
            <sql>
               SELECT src.strain,
                      src.na_sequence_id,
                      src.country,
                      src.collected_by,
                      src.note,
											etn.sequence,
                      $$projectId$$ as project_id
               FROM   DoTS.IsolateSource src,
                      DoTS.ExternalNASequence etn
               WHERE  src.na_sequence_id = $$primaryKey$$
                  AND src.na_sequence_id = etn.na_sequence_id
           </sql>
      </sqlQuery>

        <sqlQuery name="Sequence" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="organism" sortingTable="apidb.IsolateAttributes"/> 
            <column name="strain" sortingTable="apidb.IsolateAttributes"/> 
            <column name="specific_host" sortingTable="apidb.IsolateAttributes"/> 
            <column name="description"/> 
            <column name="isolation_source" sortingTable="apidb.IsolateAttributes"/> 
            <column name="pcr_primers"/> 
            <column name="country"/> 
            <column name="query_name"/> 
            <column name="target_name"/> 
            <column name="min_subject_start"/> 
            <column name="max_subject_end"/> 
            <column name="note"/> 
            <column name="product"/> 
            <column name="is_reference"/> 
            <column name="map" sortingTable="apidb.IsolateAttributes"/> 
            <sql>
               SELECT iso.source_id, 
                      iso.organism,
                      iso.strain,
                      iso.specific_host,
                      iso.isolation_source,
                      iso.description,
                      iso.pcr_primers,
                      iso.country,
                      iso.query_name, 
                      iso.target_name, 
                      iso.min_subject_start,
                      iso.max_subject_end,
                      iso.note,
                      iso.product,
                      decode(iso.is_reference, 0, 'No', 1, 'Yes', 'No') is_reference,
                      iso.map, 
                      $$projectId$$ as project_id
               FROM   ApiDB.IsolateAttributes iso
               WHERE  iso.source_id = $$primaryKey$$
           </sql>
      </sqlQuery>

      <sqlQuery name="DNASequence" isCacheable='true' includeProjects="CryptoDB,ApiDB">
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="sequence"/>
            <sql includeProjects="CryptoDB,GiardiaDB">
               SELECT etn.source_id, 
                      etn.sequence,
                      $$projectId$$ as project_id
               FROM   DoTS.ExternalNASequence etn,
                      SRes.ExternalDatabaseRelease edr,
                      SRes.ExternalDatabase edb
               WHERE  edr.external_database_id = edb.external_database_id
                  AND edr.external_database_release_id = etn.external_database_release_id
                  AND edb.name = 'Isolates Data'
                  AND edr.version = '2007-12-12'
                  AND etn.source_id = $$primaryKey$$
           </sql>
           <sql includeProjects="ApiDB">
               SELECT etn.source_id, 
                      etn.sequence,
                      $$projectId$$ as project_id
               FROM   DoTS.ExternalNASequence etn
               WHERE  etn.source_id = $$primaryKey$$
           </sql>
      </sqlQuery>

      <sqlQuery name="ProteinSequence" isCacheable='true'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="gene_description"/>
            <column name="protein_sequence"/>
            <sql>
               SELECT etn.source_id, 
                      tas.description as gene_description,
                      tas.sequence as protein_sequence,
                      $$projectId$$ as project_id
               FROM   DoTS.TranslatedAAFeature taf,
                      DoTS.TranslatedAASequence tas,
                      DoTS.Transcript trp, 
                      DoTS.IsolateFeature gf,
                      DoTS.ExternalNASequence etn,
                      SRes.ExternalDatabaseRelease edr,
                      SRes.ExternalDatabase edb
               WHERE  edr.external_database_id = edb.external_database_id
                  AND edr.external_database_release_id = etn.external_database_release_id
                  AND edb.name = 'Isolates Data'
                  AND edr.version = '2007-12-12'
                  AND trp.na_feature_id = taf.na_feature_id
                  AND tas.aa_sequence_id = taf.aa_sequence_id
                  AND trp.parent_id = gf.na_feature_id
                  AND etn.na_sequence_id = gf.na_sequence_id
                  AND etn.source_id = $$primaryKey$$
           </sql>
      </sqlQuery>

      <sqlQuery name="Reference" isCacheable='true'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="title"/>
            <column name="author"/>
            <column name="year"/>
            <column name="journal_or_book_name"/>
            <column name="journal_vol"/>
            <column name="journal_page"/>
            <sql>
               SELECT rownum as row_number, 
                      etn.source_id, 
                      ref.title,
                      ref.author,
                      ref.year,
                      ref.journal_or_book_name,
                      ref.journal_vol,
                      ref.journal_page,
                      $$projectId$$ as project_id
               FROM   DoTS.ExternalNASequence etn,
                      DoTS.NASequenceRef nasr,
                      SRES.Reference ref,
                      SRes.ExternalDatabaseRelease edr,
                      SRes.ExternalDatabase edb
               WHERE  edr.external_database_id = edb.external_database_id
                  AND edr.external_database_release_id = etn.external_database_release_id
                  AND edb.name = 'Isolates Data'
                  AND edr.version = '2007-12-12'
                  AND nasr.reference_id = ref.reference_id
                  AND etn.na_sequence_id = nasr.na_sequence_id
                  AND etn.source_id = $$primaryKey$$
                  and rownum = 1
               ORDER BY ref.reference_id asc
           </sql>
      </sqlQuery>

      <sqlQuery name="GeneOverlap" isCacheable='true'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="gene"/>
            <column name="gene_product"/>
            <sql>
            <![CDATA[
              SELECT t.source_id,
                     gf.product gene_product,
                     gf.source_id as gene,
                     $$projectId$$ as project_id
              FROM   DoTS.GeneFeature gf,
                     DoTS.ExternalNASequence etn,
                     DoTS.NaLocation nal,
                     (SELECT source_id, target_name, min_subject_start,
                             max_subject_end, product 
                      FROM   ApiDB.IsolateAttributes) t
              WHERE etn.na_sequence_id = gf.na_sequence_id
                AND nal.na_feature_id = gf.na_feature_id
                AND t.target_name = etn.source_id
                AND nal.start_min <= t.max_subject_end
                AND nal.end_max >= t.min_subject_start
                AND t.source_id = $$primaryKey$$
            ]]>
           </sql>
      </sqlQuery>

    </querySet>
</wdkModel>
