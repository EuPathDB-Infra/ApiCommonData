<wdkModel>

  <querySet name="CommentTables" queryType="table">

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">PF11_0344</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB">
          <paramValue name="source_id">TGME49_021330</paramValue>
          <paramValue name="project_id">ToxoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
          <paramValue name="source_id">cgd3_1400</paramValue>
          <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="GiardiaDB">
          <paramValue name="source_id">GL50803_112048</paramValue>
          <paramValue name="project_id">GiardiaDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="TrichDB">
          <paramValue name="source_id">TVAG_386080</paramValue>
          <paramValue name="project_id">TrichDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="TriTrypDB">
          <paramValue name="source_id">Tb927.7.4060</paramValue>
          <paramValue name="project_id">TriTrypDB</paramValue>
      </defaultTestParamValues>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- User Comments -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="GeneComments"
                 isCacheable="false">

            <testParamValues includeProjects="CryptoDB">
               <paramValue name="source_id">cgd5_780</paramValue>
            </testParamValues>
            <testParamValues minRows="0" includeProjects="TrichDB"/>
            <testParamValues includeProjects="GiardiaDB">
               <paramValue name="source_id">GL50803_39483</paramValue>
            </testParamValues>
            <testParamValues includeProjects="ToxoDB">
               <paramValue name="source_id">TGME49_102050</paramValue>
            </testParamValues>
           <!--Revisit to add an actual source_id.. the user comments table is currently empty-->
           <!-- <testParamValues includeProjects="TriTrypDB">
               <paramValue name="source_id"></paramValue>
            </testParamValues>-->
            <testParamValues minRows="0" includeProjects="TriTrypDB"/>

            <column name="source_id"/>
            <column name="project_id"/>
            <column name="comment_id"/>
            <column name="pmids"/>
            <column name="genecount"/>
            <column name="filecount"/>
            <column name="stable_id"/>
            <column name="headline"/>
            <column name="user_name_org"/>
            <column name="comment_date"/>
            <sql>
            <![CDATA[
              SELECT ga.source_id, ga.project_id, apicomm.comment_id,
                     apicomm.stable_id, apicomm.comment_date, apicomm.geneCount,
                     apicomm.filecount, apicomm.pmids, apicomm.headline, apicomm.user_name_org
              FROM apidb.GeneAttributes ga,
                   (SELECT c.project_name as project_id, csi.comment_id, csi.stable_id, c.comment_date, c.headline,
                           files.filecount, references.pmids, gene_counts.geneCount,
                           u.first_name || ' ' || u.last_name || ', ' || u.organization as user_name_org
                    FROM @COMMENT_SCHEMA@comments@COMMENT_DBLINK@ c, @USER_SCHEMA@users@USER_DBLINK@ u,
                         ( SELECT comment_id, stable_id from @COMMENT_SCHEMA@comments@COMMENT_DBLINK@
                          UNION
                           SELECT comment_id, stable_id from @COMMENT_SCHEMA@commentStableId@COMMENT_DBLINK@) csi,
                         (SELECT comment_id, count(*) as filecount
                          FROM @COMMENT_SCHEMA@CommentFile@COMMENT_DBLINK@
                          GROUP BY comment_id) files,
                         (SELECT comment_id,
                                  apidb.tab_to_string(cast(collect(source_id) as apidb.varchartab),',') as pmids
                          FROM @COMMENT_SCHEMA@CommentReference@COMMENT_DBLINK@
                          WHERE database_name='pubmed'
                          GROUP BY comment_id
                          ) references,
                         (SELECT comment_id, count(stable_id) as geneCount
                          FROM @COMMENT_SCHEMA@commentStableId@COMMENT_DBLINK@
                          GROUP BY comment_id) gene_counts
                    WHERE c.project_name = '@PROJECT_ID@'
                      AND c.comment_target_id = 'gene'
                      AND c.review_status_id != 'rejected'
                      AND c.review_status_id != 'task'
                      AND c.is_visible = 1
                      AND c.comment_id = csi.comment_id
                      AND c.user_id = u.user_id
                      AND c.comment_id = files.comment_id(+)
                      AND c.comment_id = references.comment_id(+)
                      AND c.comment_id = gene_counts.comment_id(+)
                   ) apicomm
              WHERE ga.source_id = apicomm.stable_id
                AND ga.project_id = apicomm.project_id
              ORDER BY apicomm.comment_id desc
            ]]>
            </sql>
        </sqlQuery>

   </querySet>

</wdkModel>
