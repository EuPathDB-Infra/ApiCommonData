<wdkModel>
    <querySet name="EstTables">

        <!-- EstTables.AlignmentInfo -->
        <sqlQuery name="AlignmentInfo"  isCacheable='true' excludeProjects="ApiDB">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="accession" />
            <column name="sequence_id" />
            <column name="target_start" />
            <column name="target_end" />
            <column name="context_start" />
            <column name="context_end" />
            <column name="percent_identity" />
            <column name="is_consistent" />
            <column name="is_best_alignment" />
            <column name="is_reversed" />
            <sql>
            <![CDATA[
            SELECT sequence_id, accession, target_start, target_end, context_start, context_end, 
                   is_best_alignment, is_consistent, is_reversed, percent_identity
            FROM (
                   SELECT distinct (enas.source_id) as sequence_id,
                          e.accession,
                          blat.target_start,
                          blat.target_end,
                          blat.target_start - 10000 as context_start,
                          blat.target_end + 10000 as context_end,
                          decode(blat.is_best_alignment,0,'No',1,'Yes',blat.is_best_alignment) as is_best_alignment, 
                          decode(blat.is_consistent,0,'No',1,'Yes',blat.is_consistent) as is_consistent, 
                          decode(blat.is_reversed,0,'+',1,'-',blat.is_reversed) as is_reversed, 
                          blat.percent_identity
                   FROM   dots.blatalignment blat,
                          dots.est e,
                          dots.nasequence enas
                   WHERE  blat.query_na_sequence_id = e.na_sequence_id
                     AND  blat.target_na_sequence_id = enas.na_sequence_id
                     AND  e.accession = $$primaryKey$$ )
                   ORDER BY sequence_id, is_best_alignment desc, is_consistent desc, percent_identity desc
            ]]>
            </sql>
        </sqlQuery>

        <!-- EstTables.ClusterMates -->
        <sqlQuery name="ClusterMates"  includeProjects="CryptoDB,ToxoDB"
              displayName="Other ESTs that Cluster with this EST" isCacheable='true'>
            <paramRef ref="recordParams.primaryKey"/> 
            <paramRef ref="recordParams.projectId"/>
            <column name="mate_id" />
            <column name="mate_type" />
            <sql>
            <![CDATA[           
            select enas.source_id as mate_id, 'EST' as mate_type
            from dots.assembly asmbly, dots.assemblysequence aseq, dots.ExternalNASequence enas
            where aseq.assembly_na_sequence_id = asmbly.na_sequence_id 
            and aseq.na_sequence_id = enas.na_sequence_id
            and asmbly.na_sequence_id = 
            (select asmbly.na_sequence_id from dots.assembly asmbly, 
            dots.assemblysequence aseq, dots.ExternalNASequence enas
            where aseq.assembly_na_sequence_id = asmbly.na_sequence_id 
            and aseq.na_sequence_id = enas.na_sequence_id
            and enas.source_id = $$primaryKey$$)
            and enas.source_id != $$primaryKey$$
            order by enas.source_id
            ]]>
            </sql>
        </sqlQuery>


        <!-- EstTables.AssemblyInfo -->
        <sqlQuery name="AssemblyInfo"  includeProjects="CryptoDB,ToxoDB"
              displayName="Assembly for this EST" isCacheable='true'>
            <paramRef ref="recordParams.primaryKey"/> 
            <paramRef ref="recordParams.projectId"/>
            <column name="assembly_source_id" />
            <column name="assembly_length" />
            <column name="number_of_contained_sequences" />

            <sql>
            <![CDATA[           
            SELECT asmbly.source_id as assembly_source_id,
                   asmbly.number_of_contained_sequences, 
                   asmbly.length as assembly_length
            FROM   dots.assembly asmbly, dots.assemblysequence aseq, dots.ExternalNASequence enas
            WHERE  aseq.assembly_na_sequence_id = asmbly.na_sequence_id 
            AND    aseq.na_sequence_id = enas.na_sequence_id
            AND    enas.source_id = $$primaryKey$$
            ]]>
            </sql>

        </sqlQuery>


    </querySet>
</wdkModel>
