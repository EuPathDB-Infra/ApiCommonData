<wdkModel>

<!-- notes

  - so far this is only a unification of p and t.  crypto seemed pretty different

  - the pathways query is diff between t and p, but shouldn't be.  one is wrong.

--> 

  <querySet name="IsolateTables">
    
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Mapping -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="Mapping" isCacheable="true" includeProjects="CryptoDB,ApiDB">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="name"/>
            <column name="organism"/>
            <column name="strain"/>
            <column name="specific_host"/>
            <sql>
            <![CDATA[
             SELECT extq.source_id,
                    extq.source_id name,
                    src.organism,
                    src.strain,
                    src.specific_host,
                    '@PROJECT_ID@' as project_id
             FROM   dots.SIMILARITY sim,
                    dots.SOURCE src,
                    dots.EXTERNALNASEQUENCE extt,
                    dots.EXTERNALNASEQUENCE extq,
                    (SELECT extt.source_id target_name,
                            sim.min_subject_start - 1000 as min_subject_start,
                            sim.max_subject_end + 1000 as max_subject_end
                     FROM   dots.SIMILARITY sim,
                            dots.EXTERNALNASEQUENCE extt,
                            dots.EXTERNALNASEQUENCE extq
                     WHERE  sim.query_id = extq.na_sequence_id
                        AND sim.subject_id = extt.na_sequence_id
                        AND extq.source_id = $$primaryKey$$
                    ) map
              WHERE sim.query_id = extq.na_sequence_id
                AND sim.subject_id = extt.na_sequence_id
                AND extt.source_id = map.target_name
                AND src.na_sequence_id = extq.na_sequence_id
                AND sim.min_subject_start > map.min_subject_start
                AND sim.max_subject_end < map.max_subject_end
            ]]>
            </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Publication -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="Reference" isCacheable="true" includeProjects="CryptoDB,ApiDB">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="title"/>
            <column name="author"/>
            <column name="journal_or_book_name"/>
            <sql>
            <![CDATA[
            SELECT etn.source_id,
                   ref.title,
                   ref.author,
                   ref.journal_or_book_name,
                   $$projectId$$ as project_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id = $$primaryKey$$
						ORDER BY ref.reference_id
            ]]>
            </sql>
        </sqlQuery>

   </querySet>
</wdkModel>
