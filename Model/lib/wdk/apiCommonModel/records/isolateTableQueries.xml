<wdkModel>

<!-- notes

  - so far this is only a unification of p and t.  crypto seemed pretty different

  - the pathways query is diff between t and p, but shouldn't be.  one is wrong.

--> 

  <querySet name="IsolateTables" queryType="table" includeProjects="CryptoDB,PlasmoDB, ApiDB">
    
      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">BC.458098</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">AY168847</paramValue>
         <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Publication -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="Reference" isCacheable="true" includeProjects="CryptoDB,ApiDB">
            <paramRef ref="recordParams.source_id"/>
            <paramRef ref="recordParams.project_id"/>
            <column name="source_id" />
            <column name="project_id" />
            <column name="title"/>
            <column name="author"/>
            <column name="journal_or_book_name"/>
            <sql>
            <![CDATA[
            SELECT etn.source_id,
                   ref.title,
                   ref.author,
                   ref.journal_or_book_name,
                   '@PROJECT_ID@' as project_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id = $$source_id$$
            ORDER BY ref.reference_id
            ]]>
            </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolates in the same study -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="IsoStudy" isCacheable="true" includeProjects="CryptoDB,ApiDB">

         <testParamValues includeProjects="CryptoDB">
            <paramValue name="source_id">AF266267</paramValue>
         </testParamValues>

            <paramRef ref="recordParams.source_id"/>
            <paramRef ref="recordParams.project_id"/>
            <column name="source_id" />
            <column name="project_id" />
            <column name="definition" />
            <column name="checkbox" />
            <column name="strain" />
            <column name="organism" />
            <sql>
            <![CDATA[
            SELECT distinct etn.source_id,
                   '<input type="checkbox" name="selectedFields" value="' || etn.source_id || '">' checkbox,
                   etn.description definition,
                   src.organism organism,
                   src.strain || src.isolate strain,
                   '@PROJECT_ID@' as project_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.IsolateSource src,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  src.na_sequence_id = etn.na_sequence_id
               AND edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id != $$source_id$$
               AND ref.title != 'Direct Submission'
               AND ref.reference_id IN 
            (
            SELECT distinct ref.reference_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id = $$source_id$$
            )
            ORDER BY etn.source_id
            ]]>
            </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Barcode SNPs -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="SNP" isCacheable="true" includeProjects="ApiDB,PlasmoDB">
            <paramRef ref="recordParams.source_id"/>
            <paramRef ref="recordParams.project_id"/>
            <column name="source_id" />
            <column name="project_id" />
            <column name="start_min"/>
            <column name="chromosome"/>
            <column name="allele"/>
            <column name="snp_id"/>
            <column name="colored_allele"/>
            <column name="major_allele"/>
            <column name="minor_allele"/>
            <sql>
            <![CDATA[
            SELECT nal.start_min,
                   chr.source_id chromosome,
                   if.source_id snp_id, 
                   if.source_id source_id, 
                   if.allele,
                   case when if.allele = snp.major_allele
                        then '<font color=#342D7E><b>' || if.allele || '</b></font>'
                        else  if.allele
                   end colored_allele,
                   snp.major_allele,
                   snp.minor_allele,
                   '@PROJECT_ID@' as project_id
            FROM   ApiDB.IsolateAttributes etn,
                   DoTS.IsolateFeature if,
                   DoTS.IsolateSource src,
                   DoTS.ExternalNASequence chr,
                   DoTS.NALocation nal,
                   ( SELECT source_id, major_allele, minor_allele
                     FROM   DoTS.SNPFeature ) snp 
            WHERE  etn.na_sequence_id = src.na_sequence_id
               AND src.na_feature_id = if.parent_id
               AND nal.na_feature_id = if.na_feature_id
               AND chr.na_sequence_id = if.na_sequence_id
               AND snp.source_id = if.source_id
               AND etn.source_id = $$source_id$$
            ORDER BY if.source_id
            ]]>
            </sql>
        </sqlQuery>

   </querySet>
</wdkModel>
