<wdkModel>
    <querySet name="SageTagAttributes">

        <sqlQuery name="Attrs" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="tag_sequence"/> 
            <column name="sequence_id"/>
            <column name="start_min"/>
            <column name="end_max"/>
            <column name="strand"/>
            <column name="context_start"/>
            <column name="context_end"/>
            <column name="organism"/>
            <column name="rad_source_id"/>
            <sql>
            <![CDATA[
            select sta.project_id,
                   sta.source_id, 
                   'CATG' || sta.sequence as tag_sequence,
                   sta.sequence_source_id as sequence_id,
                   sta.start_min,
                   sta.end_max,
                   case when sta.is_reversed = 1 then '-' when sta.is_reversed = 0 then '+' else '.' end as strand,
                   sta.start_min - 5000 as context_start,
                   sta.end_max + 5000 as context_end,
                   sta.organism,
                   case when sta.rad_source_id is null then 'N/A' else sta.rad_source_id end as rad_source_id
            from apidb.SageTagAttributes sta
            where sta.source_id = $$primaryKey$$
            ]]>
           </sql>
      </sqlQuery>


      <sqlQuery name="Gene" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="gene_source_id"/>
            <sql>
            <![CDATA[
            select apidb.tab_to_string(CAST(COLLECT(distinct(sg.gene_source_id)) AS apidb.varchartab),', ') as gene_source_id, a.source_id, a.project_id
            from apidb.SAGETAGGENE sg, apidb.SAGETAGATTRIBUTES a
            where  sg.distance = 0
            and a.na_feature_id = sg.tag_feature_id
            and a.is_reversed = sg.antisense
            and a.source_id = $$primaryKey$$
            group by a.source_id, a.project_id
            ]]>
           </sql>
      </sqlQuery>


      <sqlQuery name="AlignmentCount" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="total_alignments"/>
            <sql>
            <![CDATA[
            select count(distinct na_feature_id) as total_alignments
            from apidb.SAGETAGATTRIBUTES
            where source_id = $$primaryKey$$
            ]]>
           </sql>
      </sqlQuery>

       <sqlQuery name="GeneCount" isCacheable='false'>
            <paramRef ref="recordParams.projectId"/>
            <paramRef ref="recordParams.primaryKey"/>
            <column name="number_of_genes_hit"/>
            <sql>
            <![CDATA[
            select count(distinct sg.gene_source_id) as number_of_genes_hit
            from apidb.SAGETAGGENE sg, apidb.SAGETAGATTRIBUTES a
            where a.na_feature_id = sg.tag_feature_id
            and a.IS_REVERSED=sg.antisense
            and a.composite_element_id in
                    (select composite_element_id
                     from apidb.SageTagAttributes
                     where source_id = $$primaryKey$$)
            ]]>
           </sql>
      </sqlQuery>
 </querySet>

</wdkModel>
