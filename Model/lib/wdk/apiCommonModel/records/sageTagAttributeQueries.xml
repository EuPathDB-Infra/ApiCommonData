<wdkModel>
    <querySet name="SageTagAttributes">

        <sqlQuery name="Attrs" isCacheable='false'>
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="tag_sequence" sortingTable="apidb.sagetagattributes" sortingColumn="sequence"/> 
            <column name="sequence_id"  sortingTable="apidb.sagetagattributes" sortingColumn="sequence_source_id"/>
            <column name="start_min"  sortingTable="apidb.sagetagattributes"/>
            <column name="end_max"  sortingTable="apidb.sagetagattributes"/>
            <column name="strand"  sortingTable="apidb.sagetagattributes" sortingColumn="is_reversed"/>
            <column name="context_start"/>
            <column name="context_end"/>
            <column name="organism"  sortingTable="apidb.sagetagattributes"/>
            <column name="rad_source_id"  sortingTable="apidb.sagetagattributes"/>
            <column name="gene_source_id" sortingTable="apidb.sagetagattributes"/>
            <column name="gene_product" sortingTable="apidb.sagetagattributes"/>
            <column name="feature_source_id" sortingTable="apidb.sagetagattributes"/>
            <sql>
            <![CDATA[
            select sta.project_id,
                   sta.source_id, 
                   'CATG' || sta.sequence as tag_sequence,
                   sta.sequence_source_id as sequence_id,
                   sta.start_min,
                   sta.end_max,
                   case when sta.is_reversed = 1 then '-' when sta.is_reversed = 0 then '+' else '.' end as strand,
                   sta.start_min - 5000 as context_start,
                   sta.end_max + 5000 as context_end,
                   sta.organism,
                   case when sta.rad_source_id is null then 'N/A' else sta.rad_source_id end as rad_source_id,
                   gene_source_id,
                   gene_product,
                   feature_source_id
            from apidb.SageTagAttributes sta
            ]]>
           </sql>
      </sqlQuery>


      <sqlQuery name="AlignmentCount" isCacheable='false'>
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="total_alignments"/>
            <sql>
            <![CDATA[
             select a.source_id, '@project_id@' AS project_id, 
                    count(*) as total_alignments
             from apidb.SAGETAGATTRIBUTES a
             where a.composite_element_id in 
                 (select composite_element_id 
                  from apidb.SAGETAGATTRIBUTES 
                  where source_id = $$primaryKey$$)
            group by a.source_id, a.composite_element_id
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="GeneAlignmentCount" isCacheable='false'>
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="total_gene_alignments"/>
            <sql>
            <![CDATA[
             select a.source_id, '@project_id@' AS project_id, 
                    sum(gene_count) as total_gene_alignments
             from apidb.SAGETAGATTRIBUTES a
             where a.composite_element_id in 
                 (select composite_element_id 
                  from apidb.SAGETAGATTRIBUTES 
                  where source_id = $$primaryKey$$)
            group by a.source_id, a.composite_element_id
            ]]>
           </sql>
      </sqlQuery>

 </querySet>

</wdkModel>
