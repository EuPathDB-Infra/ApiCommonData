<wdkModel>
    <querySet name="SequenceTables">

        <sqlQuery name="SequencePieces" includeProjects="GiardiaDB"
               isCacheable="false">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="source_id" />
            <column name="start_min" />
            <column name="end_max" />
            <column name="piece_source_id" />
            <column name="piece_min" />
            <column name="piece_max" />
            <column name="piece_strand" />
            <sql>
            <![CDATA[
            select vs.source_id as source_id, 
                   sp.distance_from_left + 1 as start_min, 
                   es.length + sp.distance_from_left as end_max,
                   case when es.source_id is null then '(N)-' || es.length else es.source_id end as piece_source_id,
                   1 as piece_min,
                   es.length as piece_max,
                   sp.strand_orientation as piece_strand
            from Dots.SEQUENCEPIECE sp, Dots.NASEQUENCE vs, Dots.NASEQUENCE es
            where vs.na_sequence_id = sp.virtual_na_sequence_id
            and es.na_sequence_id = sp.piece_na_sequence_id
            and (vs.source_id = $$primaryKey$$ or es.source_id = $$primaryKey$$)
            order by vs.source_id, sp.sequence_order
             ]]>
           </sql>
        </sqlQuery>



        <sqlQuery name="Centromere" includeProjects="PlasmoDB"
               isCacheable="false">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="start_min" />
            <column name="end_max" />
            <sql>
            <![CDATA[
            SELECT nl.start_min, nl.end_max
            FROM dots.NaSequence ens, dots.Miscellaneous m,
                 dots.NaLocation nl, sres.SequenceOntology so
            WHERE ens.source_id = $$primaryKey$$
              AND ens.na_sequence_id = m.na_sequence_id
              AND m.na_feature_id = nl.na_feature_id
              AND m.sequence_ontology_id = so.sequence_ontology_id
              AND so.term_name = 'centromere'
             ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="SequenceComments"  excludeProjects="ApiDB"
               isCacheable="false">
            <paramRef ref="recordParams.primaryKey"/>
            <paramRef ref="recordParams.projectId"/>
            <column name="comment_id"/>
            <column name="stable_id"/>
            <column name="headline"/>
            <column name="user_name"/>
            <column name="organization"/>
            <column name="comment_date"/>
            <sql>
            <![CDATA[
              SELECT DISTINCT c.comment_id, c.stable_id,
                     NVL(c.headline, '<i>none</i>') AS headline,
                     (u.first_name || ' ' || u.last_name) AS user_name,
					 u.organization,
                     c.comment_date
              FROM @LOGIN_SCHEMA@users@LOGIN_DBLINK@ u,
                   @COMMENT_SCHEMA@comments@COMMENT_DBLINK@ c,
                   dots.NaSequence ens
              WHERE u.email = c.email
                    AND c.comment_target_id = 'genome'
                    AND c.stable_id = ens.source_id
                    AND ens.source_id = $$primaryKey$$
            ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="SequenceGffDbxrefs"  excludeProjects="ApiDB" 
            isCacheable="false">
        <paramRef ref="recordParams.primaryKey"/>
        <paramRef ref="recordParams.projectId"/>
        <column name="gff_dbxref"/>
        <sqlParamValue name="brcName" includeProjects="PlasmoDB">ApiDB_PlasmoDB</sqlParamValue>
        <sqlParamValue name="brcName" includeProjects="CryptoDB">ApiDB_CryptoDB</sqlParamValue>
        <sqlParamValue name="brcName" includeProjects="ToxoDB">ApiDB_ToxoDB</sqlParamValue>
        <sqlParamValue name="brcName" includeProjects="GiardiaDB,TrichDB">ApiDB</sqlParamValue>
        <sql>
          <![CDATA[
            SELECT ens.source_id,
                   'taxon:' || t.ncbi_tax_id AS gff_dbxref
            FROM dots.NaSequence ens, sres.Taxon t
            WHERE ens.source_id = $$primaryKey$$
              AND ens.taxon_id = t.taxon_id
/*           UNION
            SELECT ens.source_id, so.so_id AS gff_dbxref
            FROM dots.NaSequence ens, sres.SequenceOntology so
            WHERE ens.source_id = $$primaryKey$$
              AND ens.sequence_ontology_id = so.sequence_ontology_id
*/           UNION
            SELECT ens.source_id,
                   'GenBank:' || dr.primary_identifier AS thingie
            FROM dots.NaSequence ens, dots.dbrefNaSequence drns,
                 sres.DbRef dr, sres.ExternalDatabaseRelease edr,
                 sres.ExternalDatabase ed
            WHERE ens.source_id = $$primaryKey$$
              AND ens.na_sequence_id = drns.na_sequence_id
              AND drns.db_ref_id = dr.db_ref_id
              AND dr.external_database_release_id
                  = edr.external_database_release_id
              AND edr.external_database_id = ed.external_database_id
              AND ed.name = 'GenBank'
           UNION
            SELECT ens.source_id,
                   '&&brcName&&:' || ens.source_id AS gff_dbxref
            FROM dots.NaSequence ens
            WHERE ens.source_id = $$primaryKey$$
          ]]>
        </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
