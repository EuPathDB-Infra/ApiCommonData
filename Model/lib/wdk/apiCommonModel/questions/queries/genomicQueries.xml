<wdkModel>

   <!-- notes

      - in SourceId query changed 'sequence' and 'contig' param to 'sharedParams.genomicSequence'

      - in taxon query changed apidb's seqorganism to organism

      - assumes that NAsequence table has source_id

   -->
  <querySet name="SequenceIds" queryType="id">
    
    <!-- ************************************************************ -->
    <!-- SourceId -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="SequenceBySourceId" doNotTest="true" excludeProjects="ApiDB"
        isCacheable="true">
        <paramRef ref="genomicParams.sequenceId" default="TGME49_chrIa" includeProjects="ToxoDB"/> 
        <paramRef ref="genomicParams.sequenceId" default="MAL4" includeProjects="PlasmoDB"/> 
        <paramRef ref="genomicParams.sequenceId" excludeProjects="ToxoDB,PlasmoDB"/> 
        <column name="source_id"/>
        <column name="project_id"/>
        <sql includeProjects="CryptoDB">
             <![CDATA[
            SELECT distinct enas.source_id, '@PROJECT_ID@' as project_id
            FROM dots.externalnasequence enas,
                 sres.sequenceontology so, @WDK_ENGINE_SCHEMA@dataset_values@USER_DBLINK@ ds
            WHERE  ds.dataset_id = $$sequenceId$$
            AND LOWER(enas.source_id) LIKE TRIM(REGEXP_REPLACE(REPLACE(LOWER(ds.dataset_value),'*', '%'),'[[:space:]]', ''))
            AND enas.sequence_ontology_id = so.sequence_ontology_id
            AND so.term_name in ('contig', 'supercontig')
           ]]>
        </sql>
        <sql includeProjects="PlasmoDB,ToxoDB,GiardiaDB,TrichDB">
        <![CDATA[
            SELECT distinct sequence as source_id, '@PROJECT_ID@' as project_id
            FROM apidb.SequenceId si, @WDK_ENGINE_SCHEMA@dataset_values@USER_DBLINK@ ds
            WHERE  ds.dataset_id = $$sequenceId$$
              AND LOWER(id) LIKE REGEXP_REPLACE(REPLACE(LOWER(ds.dataset_value),'*', '%'),'[[:space:]]', '')
           ]]>
        </sql>
    </sqlQuery>
    
    <processQuery name="SequenceBySourceId" includeProjects="ApiDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="genomicParams.sequenceId"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>
    
    
    <!-- ************************************************************ -->
    <!-- Species -->  
    <!-- ************************************************************ -->

    <sqlQuery name="SequencesByTaxon" excludeProjects="ApiDB"
        isCacheable="true">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"
                  excludeProjects="ToxoDB"/>
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withSequenceStrains" 
                  includeProjects="ToxoDB"/>
        <paramRef ref="genomicParams.sequenceTypes" includeProjects="GiardiaDB"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql includeProjects="PlasmoDB,ToxoDB,CryptoDB,TrichDB">
            <![CDATA[
            SELECT ens.source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence ens,apidb.sequenceattributes atr
            WHERE ens.taxon_id IN ($$organism$$)
               AND atr.na_sequence_id = ens.na_sequence_id
               AND atr.is_top_level = 1
           ]]>
        </sql>
       <sql includeProjects="GiardiaDB">
            <![CDATA[
            SELECT DISTINCT ens.source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence ens, sres.SequenceOntology so
            WHERE ens.taxon_id IN (SELECT taxon_id FROM sres.taxon                        
               CONNECT BY parent_id = prior taxon_id
               START WITH taxon_id in ($$organism$$))
               AND ens.sequence_ontology_id = so.sequence_ontology_id
              AND so.so_id in ($$sequenceTypes$$)
            ORDER BY ens.source_id           
           ]]>
        </sql>
    </sqlQuery>
    
    <processQuery name="SequencesByTaxon" includeProjects="ApiDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>            
    </processQuery>
 
    
    <!-- ************************************************************ -->
    <!-- Similarity -->  
    <!-- ************************************************************ -->
    
    <processQuery name="SequencesBySimilarity" 
        processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">

        <testParamValues includeProjects="CryptoDB">
            <paramValue name="BlastQuerySequence">CGTATTCAAGAGAGTAGTCCATTTGGAATTGATTTCTGTCAAAGT</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="ToxoDB">
            <paramValue name="BlastQuerySequence">TCTGTTTGTGTGTGAGGTTGAAGCGCGCCCAGAAGCTGTGG</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PlasmoDB">
            <paramValue name="BlastQuerySequence">ATGGTGACGCAAAGTAGTGGTGGGGGTGCTGCTGGTAGTAGTGGTGAGGAAGATGCCAAACATGTATTGGATGAATTTGGGCAACAAGTGTACAATGAAAAAGTGGAAAAGTATGCTAATTCTAAAATATATAAAGAGGCGTTGAAAGGAGATTT</paramValue>
            <paramValue name="BlastDatabaseOrganism">Plasmodium falciparum</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <paramRef ref="sharedParams.BlastDatabaseType" quote="false" />
        <paramRef ref="sharedParams.BlastAlgorithm" quote="false" />
        <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism" quote="false" />
        <paramRef ref="sharedParams.BlastQuerySequence" quote="false" />
        <paramRef ref="sharedParams.-e" quote="false" />
        <paramRef ref="sharedParams.-v" quote="false" />
        <paramRef ref="sharedParams.-b" quote="false" />
        <paramRef ref="sharedParams.-filter" quote="false" />
        
        <wsColumn name="source_id" width="32" wsName="Identifier"/>
        <wsColumn name="project_id" width="32" wsName="ProjectId"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment" width="4000"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer" width="4000"/>
    </processQuery>
    
<!--
    <processQuery name="SequencesBySimilarity" includeProjects="ApiDB" 
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="sharedParams.BlastDatabaseType"/>
        <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism"/>
        <paramRef ref="sharedParams.BlastAlgorithm"/>
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter"/>
        
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment" width="4000"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer" width="3000"/>
    </processQuery>
    
-->

  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
  <!-- Query that retrieves all sequences by organism -->
  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="SequenceDumpQuery" isCacheable="true" excludeProjects="ApiDB">
        <paramRef ref="organismParams.gff_organism" queryRef="organismVQ.withGenesGFF"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sqlParamValue name="sequence_table" excludeProjects="ToxoDB">dots.NaSequence</sqlParamValue>
        <sqlParamValue name="sequence_table" includeProjects="ToxoDB">dots.VirtualSequence</sqlParamValue>
        <sql>
            <!-- use CDATA because query includes angle brackets -->
            <![CDATA[
            SELECT DISTINCT sa.source_id, '@PROJECT_ID@' as project_id
            FROM  
                 apidb.SequenceAttributes sa
            WHERE sa.ncbi_tax_id IN (SELECT ncbi_tax_id FROM sres.taxon                        
                                  CONNECT BY parent_id = prior taxon_id
                                  START WITH taxon_id in ($$gff_organism$$))
              AND sa.project_id = '@PROJECT_ID@'
              AND sa.is_top_level = 1
            ]]>
        </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
