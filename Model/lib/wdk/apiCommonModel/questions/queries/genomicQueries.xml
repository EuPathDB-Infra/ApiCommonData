<wdkModel>

   <!-- notes

      - in SourceId query changed 'sequence' and 'contig' param to 'sharedParams.genomicSequence'

      - in taxon query changed apidb's seqorganism to organism

      - assumes that NAsequence table has source_id

   -->
  <querySet name="SequenceIds">
    
    <!-- ************************************************************ -->
    <!-- SourceId -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="SequenceBySourceId" excludeProjects="ApiDB"
        isCacheable="true">
        <paramRef ref="sharedParams.sequenceId" default="TGG_994746" includeProjects="ToxoDB"/> 
        <paramRef ref="sharedParams.sequenceId" default="MAL4" includeProjects="PlasmoDB"/> 
        <paramRef ref="sharedParams.sequenceId" excludeProjects="ToxoDB,PlasmoDB"/> 
        <column name="source_id"/>
        <column name="project_id"/>
        <sql includeProjects="CryptoDB">
             <![CDATA[
            SELECT enas.source_id, '@PROJECT_ID@' as project_id
            FROM dots.externalnasequence enas,
                 sres.sequenceontology so
            WHERE LOWER(enas.source_id) LIKE TRIM(LOWER(REPLACE($$sequenceId$$, '*', '%')))
            AND enas.sequence_ontology_id = so.sequence_ontology_id
            AND so.term_name in ('contig', 'supercontig')
           ]]>
        </sql>
        <sql includeProjects="PlasmoDB,ToxoDB,GiardiaDB,TrichDB">
        <![CDATA[
            SELECT distinct source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence enas,
                 sres.sequenceontology so
            WHERE LOWER(source_id) LIKE LOWER(REPLACE(REPLACE($$sequenceId$$,' ',''), '*', '%'))
            AND enas.sequence_ontology_id = so.sequence_ontology_id
            AND so.term_name in ('contig', 'supercontig', 'chromosome')
           ]]>
        </sql>
    </sqlQuery>
    
    <wsQuery name="SequenceBySourceId" includeProjects="ApiDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="sharedParams.sequenceId"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </wsQuery>
    
    
    <!-- ************************************************************ -->
    <!-- Species -->  
    <!-- ************************************************************ -->

    <sqlQuery name="SequencesByTaxon" excludeProjects="ApiDB"
        isCacheable="true">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql excludeProjects="ApiDB">
            <![CDATA[
            SELECT DISTINCT ens.source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence ens, sres.SequenceOntology so
            WHERE ens.taxon_id IN (SELECT taxon_id FROM sres.taxon                        
               CONNECT BY parent_id = prior taxon_id
               START WITH taxon_id in ($$organism$$))
               AND ens.sequence_ontology_id = so.sequence_ontology_id
              AND (so.term_name = 'chromosome' 
                   OR so.term_name = 'supercontig'
                   OR so.term_name = 'contig')
            ORDER BY ens.source_id           
           ]]>
        </sql>
    </sqlQuery>
    
    <wsQuery name="SequencesByTaxon" includeProjects="ApiDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>            
    </wsQuery>
 
    
    <!-- ************************************************************ -->
    <!-- Similarity -->  
    <!-- ************************************************************ -->
    
    <wsQuery name="SequencesBySimilarity" 
        processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">

        <paramRef ref="sharedParams.BlastDatabaseType"/>
        <paramRef ref="sharedParams.BlastAlgorithm"/>
        <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism"/>
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter"/>
        
        <wsColumn name="source_id" width="32" wsName="Identifier"/>
        <wsColumn name="project_id" width="32" wsName="ProjectId"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment" width="4000"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer" width="4000"/>
    </wsQuery>
    
<!--
    <wsQuery name="SequencesBySimilarity" includeProjects="ApiDB" 
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="sharedParams.BlastDatabaseType"/>
        <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism"/>
        <paramRef ref="sharedParams.BlastAlgorithm"/>
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter"/>
        
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment" width="4000"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer" width="3000"/>
    </wsQuery>
    
-->

  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
  <!-- Query that retrieves all sequences by organism -->
  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="SequenceDumpQuery" isCacheable="true" excludeProjects="ApiDB">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sqlParamValue name="sequence_table" excludeProjects="ToxoDB">dots.NaSequence</sqlParamValue>
        <sqlParamValue name="sequence_table" includeProjects="ToxoDB">dots.VirtualSequence</sqlParamValue>
        <sql>
            <!-- use CDATA because query includes angle brackets -->
            <![CDATA[
            SELECT DISTINCT ns.source_id, '@PROJECT_ID@' as project_id
            FROM &&sequence_table&& ns, 
                 sres.SequenceOntology so,
                 apidb.SequenceAttributes sa
            WHERE ns.taxon_id IN (SELECT taxon_id FROM sres.taxon                        
                                  CONNECT BY parent_id = prior taxon_id
                                  START WITH taxon_id in ($$organism$$))
              AND ns.sequence_ontology_id = so.sequence_ontology_id
              AND (so.term_name = 'chromosome' 
                     OR so.term_name = 'supercontig'
                     OR so.term_name = 'contig')
              AND ns.source_id = sa.source_id
              AND sa.project_id = '@PROJECT_ID@'
            ]]>
        </sql>
    </sqlQuery>

  </querySet>

  <querySet name="SequenceSubTypes">
  
    <sqlQuery name="SequenceTypeFilter" includeProjects="GiardiaDB"
              isCacheable="false">
        <paramRef ref="genomicParams.genomicResult"/>
        <paramRef ref="genomicParams.genomicSequenceType"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sql>
            <![CDATA[
            SELECT c.*
            FROM ($$genomicResult$$) c,
                 apidb.sequenceattributes sa
            WHERE c.source_id = sa.source_id
              AND c.project_id = sa.project_id
              AND sa.database_name = $$genomicSequenceType$$
            ]]>
       </sql>
    </sqlQuery>  
    
  </querySet>
    
</wdkModel>
