<wdkModel>
  <querySet name="IsolateIds">

   <!-- notes
      
      - changed ms_assay param names
      - all components will have orfs so i changed the includes/excluded to reflect that

    -->
    
    <!-- ************************************************************ -->
    <!-- Isolate ID -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="IsolateByIsolateId" includeProjects="CryptoDB,PlasmoDB"
              displayName="ID" isCacheable="true">
        <paramRef ref="isolateParams.isolate_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql includeProjects="CryptoDB">
            <![CDATA[
                SELECT distinct etn.source_id as source_id, 
                       '@PROJECT_ID@' as project_id
                FROM   DoTS.ExternalNASequence etn,
                       SRes.ExternalDatabaseRelease edr,
                       SRes.ExternalDatabase edb, 
                       @LOGIN_SCHEMA@dataset_values@LOGIN_DBLINK@ ds
                 WHERE ds.dataset_id = $$isolate_id$$
                   AND lower(source_id) LIKE REGEXP_REPLACE(REPLACE(LOWER(ds.dataset_value),
                                                       '*', '%'), '[[:space:]]', '')
                   AND edr.external_database_id = edb.external_database_id
                   AND edr.external_database_release_id = etn.external_database_release_id
                   AND edb.name = 'Isolates Data'
                   AND edr.version = '2007-12-12'
            ]]>
        </sql>
        <sql includeProjects="PlasmoDB">
            <![CDATA[
            SELECT source_id, '@PROJECT_ID@' as project_id
            FROM   ApiDB.IsolateAttributes, 
                   @LOGIN_SCHEMA@dataset_values@LOGIN_DBLINK@ ds
            WHERE  ds.dataset_id = $$isolate_id$$
            AND    lower(source_id) LIKE REGEXP_REPLACE(REPLACE(LOWER(ds.dataset_value),
                                                       '*', '%'), '[[:space:]]', '')
            ]]>
        </sql>
    </sqlQuery>

    <processQuery name="IsolateByIsolateId" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.isolate_id"/>
       <paramRef ref="sharedParams.signature"/>    
       <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!-- ************************************************************ -->
    <!-- Isolate Author -->
    <!-- ************************************************************ -->

    <sqlQuery name="IsolateByAuthor" includeProjects="CryptoDB"
              displayName="Author" isCacheable="true">
      <paramRef ref="isolateParams.author"/>
      <column name="source_id"/>
      <column name="project_id"/>
      <sql includeProjects="CryptoDB">
      <![CDATA[
          SELECT distinct etn.source_id as source_id,
                 '@PROJECT_ID@' as project_id
          FROM   DoTS.ExternalNASequence etn,
                 DoTS.NASequenceRef nasr,
                 SRES.Reference ref,
                 SRes.ExternalDatabaseRelease edr,
                 SRes.ExternalDatabase edb
          WHERE  nasr.reference_id = ref.reference_id
             AND edr.external_database_id = edb.external_database_id
             AND edr.external_database_release_id = etn.external_database_release_id
             AND edb.name = 'Isolates Data'
             AND edr.version = '2007-12-12'
             AND etn.na_sequence_id = nasr.na_sequence_id
             AND LOWER(ref.author) LIKE LOWER(REPLACE($$author$$,'*','%'))
         ]]>
      </sql>
    </sqlQuery>

    <processQuery name="IsolateByAuthor" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.author"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Taxon (Species, Organism) -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByTaxon" includeProjects="CryptoDB">
        <paramRef ref="isolateParams.isolate_organism" queryRef="organismIQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT etn.source_id, '@PROJECT_ID@' as project_id
            FROM   DoTS.IsolateSource src, 
                   DoTS.ExternalNASequence etn,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  etn.na_sequence_id IN
                   (SELECT sc.na_sequence_id
                    FROM DoTS.IsolateSource sc
                    WHERE sc.organism in ($$isolate_organism$$)
                   )
               AND etn.source_id IS NOT NULL
               AND etn.na_sequence_id = src.na_sequence_id
               AND edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
            ORDER BY etn.source_id
            ]]>
         </sql>
    </sqlQuery>

    <sqlQuery name="IsolateByTaxon" includeProjects="PlasmoDB">
        <paramRef ref="isolateParams.strain" queryRef="strainVQ.withIsolates" quote="true"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="data_type"/>
        <sql>
          <![CDATA[
            SELECT src.source_id, '@PROJECT_ID@' as project_id, src.data_type,src.strain
            FROM   ApiDB.IsolateAttributes src
            WHERE  lower(regexp_replace(src.strain, '[-_/]', '-')) in ($$strain$$)
            AND  src.data_type in ($$type$$)
            ORDER BY src.strain
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByTaxon" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.isolate_organism" queryRef="organismIQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Host name (Specific_host) -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByHost" includeProjects="CryptoDB">
        <paramRef ref="isolateParams.specific_host" queryRef="hostVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql >
          <![CDATA[
            SELECT DISTINCT etn.source_id, '@PROJECT_ID@' as project_id
            FROM   DoTS.IsolateSource src, 
                   DoTS.ExternalNASequence etn,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE etn.na_sequence_id IN
                  (SELECT sc.na_sequence_id
                   FROM DoTS.IsolateSource sc
                   WHERE replace(sc.specific_host, chr(39), ':') in ($$specific_host$$)
                   )
                AND etn.source_id IS NOT NULL
                AND etn.na_sequence_id = src.na_sequence_id
                AND edr.external_database_id = edb.external_database_id
                AND edr.external_database_release_id = etn.external_database_release_id
                AND edb.name = 'Isolates Data'
                AND edr.version = '2007-12-12'
            ORDER BY etn.source_id
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByHost" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.specific_host" queryRef="hostVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolation Source -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByIsolationSource" includeProjects="CryptoDB">
        <paramRef ref="isolateParams.isolation_source" queryRef="isolationSourceVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql >
          <![CDATA[
            SELECT DISTINCT src.source_id, '@PROJECT_ID@' as project_id
            FROM   ApiDB.IsolateAttributes src 
            WHERE  src.isolation_source in ($$isolation_source$$)
            ORDER BY src.source_id
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByIsolationSource" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.isolation_source" queryRef="isolationSourceVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Product -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByProduct" includeProjects="CryptoDB">
        <paramRef ref="isolateParams.product" queryRef="productVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql >
          <![CDATA[
            SELECT DISTINCT gf.source_id, '@PROJECT_ID@' as project_id
            FROM ApiDB.IsolateAttributes gf
            WHERE gf.product IN ($$product$$)
              AND gf.product IS NOT NULL
            ORDER BY gf.source_id
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByProduct" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.product" queryRef="productVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>



    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Study -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByStudy" includeProjects="CryptoDB">
        <paramRef ref="isolateParams.study" queryRef="studyVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT etn.source_id, '@PROJECT_ID@' as project_id
            FROM DoTS.ExternalNASequence etn, 
                 DoTS.NASequenceRef nasr,
                 SRES.Reference ref,
                 SRes.ExternalDatabaseRelease edr,
                 SRes.ExternalDatabase edb
            WHERE nasr.reference_id = ref.reference_id
            AND nasr.na_sequence_id = etn.na_sequence_id
            AND replace(ref.title, ',', ';') IN ($$study$$)
            AND ref.title IS NOT NULL
            AND edr.external_database_id = edb.external_database_id
            AND edr.external_database_release_id = etn.external_database_release_id
            AND edb.name = 'Isolates Data'
            AND edr.version = '2007-12-12'
            ORDER BY etn.source_id
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByStudy" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.study" queryRef="studyVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Country -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByCountry" includeProjects="CryptoDB, PlasmoDB">
        <paramRef ref="isolateParams.country" queryRef="countryVQ.withIsolates" quote="true"/>
        <paramRef ref="isolateParams.continent" queryRef="continentVQ.withIsolates" quote="true"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="data_type"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT src.source_id, '@PROJECT_ID@' as project_id,
                               src.data_type
            FROM   ApiDB.IsolateAttributes src
            WHERE  replace(src.country, ',', ';') IN ($$country$$)
                    AND  src.data_type in ($$type$$)
            UNION
            SELECT DISTINCT src.source_id, '@PROJECT_ID@' as project_id,
                   src.data_type
            FROM   ApiDB.IsolateAttributes src,
                   ApiDB.Continents cnt
            WHERE  cnt.continent IN ($$continent$$) 
              AND  src.data_type in ($$type$$) 
              AND  src.country = cnt.country
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByCountry" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.country" queryRef="countryVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Submitter -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateBySubmitter" includeProjects="PlasmoDB">
        <paramRef ref="isolateParams.submitter" queryRef="submitterVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="data_type"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT src.source_id, '@PROJECT_ID@' as project_id,
                               src.data_type
            FROM   ApiDB.IsolateAttributes src
            WHERE  src.collected_by IN ($$submitter$$)
            ORDER BY src.source_id
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateBySubmitter" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="ApiDB">
      <paramRef ref="isolateParams.submitter" queryRef="submitterVQ.withIsolates" quote="true"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolates with Gene Overlap  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateWithGeneOverlap" includeProjects="CryptoDB"
              displayName="Gene Name" isCacheable='true'>
      <paramRef ref="isolateParams.gene_id"/>
      <column name="source_id" />
      <column name="project_id"/>
      <sql>
         <![CDATA[
         SELECT distinct t.source_id,
                '@PROJECT_ID@' as project_id
         FROM   DoTS.GeneFeature gf, 
                DoTS.ExternalNASequence etn, 
                DoTS.NaLocation nal,
                 (SELECT source_id, target_name, min_subject_start, 
                         max_subject_end 
                  FROM ApiDB.IsolateAttributes) t
         WHERE etn.na_sequence_id = gf.na_sequence_id
           AND nal.na_feature_id = gf.na_feature_id
           AND t.target_name = etn.source_id
           AND nal.start_min <= t.max_subject_end 
           AND nal.end_max >= t.min_subject_start
           AND gf.source_id LIKE REPLACE($$gene_id$$,'*','%') 
        ]]>
      </sql> 
    </sqlQuery> 

    <processQuery name="IsolateWithGeneOverlap" includeProjects="ApiDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="isolateParams.gene_id"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- BLAST  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <processQuery name="IsolatesBySimilarity"
             displayName="BLAST"
             processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">
      <paramRef ref="sharedParams.BlastDatabaseType"/>
      <paramRef ref="sharedParams.BlastAlgorithm"/>
      <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism"/>
      <paramRef ref="sharedParams.BlastQuerySequence"/>
      <paramRef ref="sharedParams.-e"/>
      <paramRef ref="sharedParams.-v"/>
      <paramRef ref="sharedParams.-b"/>
      <paramRef ref="sharedParams.-filter"/>
      <wsColumn name="source_id" width="32" wsName="Identifier"/>
      <wsColumn name="project_id" width="32" wsName="ProjectId"/>
      <wsColumn name="TabularRow" width="3000"/>
      <wsColumn name="Alignment" width="4000"/>
      <wsColumn name="Header" width="3000"/>
      <wsColumn name="Footer" width="3000"/>
    </processQuery>

  </querySet>

</wdkModel>
