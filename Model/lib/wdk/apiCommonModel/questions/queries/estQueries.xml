<wdkModel>

  <!-- notes

  -->

  <querySet name="EstIds">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Source id  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstBySourceId" excludeProjects="ApiDB"
         isCacheable="true">
        <paramRef ref="estParams.est_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT est.accession AS source_id, '@PROJECT_ID@' as project_id
            FROM dots.Est est
            WHERE LOWER(accession) LIKE LOWER(REPLACE(REPLACE($$est_id$$,' ',''), '*', '%'))
          ]]>
       </sql>
    </sqlQuery>

    <wsQuery name="EstBySourceId" includeProjects="ApiDB"
          isCacheable='true' 
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="estParams.est_id"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </wsQuery>   


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Location  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <sqlQuery name="EstsByLocation" excludeProjects="ApiDB"
          isCacheable="true">
        <paramRef ref="sharedParams.chromosomeOptional" includeProjects="PlasmoDB,CryptoDB,ToxoDB"/>
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sharedParams.libraryId"/>
        <paramRef ref="sharedParams.best_alignment_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.high_confidence_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_identity" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_est_aligned" groupRef="paramGroups.advancedParams"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="est_location" excludeProjects="CryptoDB"/>
        <sqlParamValue name="chroOpt" includeProjects="PlasmoDB,ToxoDB,CryptoDB">
            <![CDATA[
              (target_sequence_source_id IN ($$chromosomeOptional$$)
               OR lower(target_sequence_source_id) = lower($$sequenceId$$))
            ]]>
        </sqlParamValue>
        <sqlParamValue name="chroOpt" includeProjects="GiardiaDB,TrichDB">
           <![CDATA[ lower(target_sequence_source_id) = lower($$sequenceId$$)]]>
        </sqlParamValue>
        <sql excludeProjects="CryptoDB">
            <![CDATA[
            SELECT accession as source_id, '@PROJECT_ID@' as project_id,
                   apidb.tab_to_string(
                     CAST(
                       COLLECT(target_sequence_source_id || ':'
                       || trim(to_char(target_start,'999,999,999'))
                       || '-' || trim(to_char(target_end,'999,999,999'))
                       || '(' || decode(is_reversed,0,'+',1,'-',null)
                       || ')') AS apidb.varchartab), ', ') AS est_location
	    FROM  apidb.ESTALIGNMENTGENESUMMARY
            WHERE &&chroOpt&&
            AND target_start >= $$start_point$$
            AND (target_end <= $$end_point$$ OR $$end_point$$ = 0)
            AND   is_consistent in ($$high_confidence_only$$)
            AND   is_best_alignment in ($$best_alignment_only$$)
            AND   percent_identity >= $$min_percent_identity$$
            AND   percent_est_bases_aligned >= $$min_percent_est_aligned$$
            AND   library_id in ($$libraryId$$)
	    GROUP BY accession
           ]]>
        </sql>
        <sql includeProjects="CryptoDB">
            <![CDATA[
           SELECT est.accession as source_id, '@PROJECT_ID@' as project_id
	    FROM  dots.BlatAlignment blat,
	          dots.AssemblySequence asbl,
		  dots.Est est,
		  dots.NASequence etn
            WHERE blat.query_na_sequence_id = asbl.na_sequence_id
	    AND   blat.target_na_sequence_id = etn.na_sequence_id
	    AND   est.na_sequence_id = blat.query_na_sequence_id
            AND   blat.target_end >= $$start_point$$ 
            AND   (blat.target_start <= $$end_point$$ OR $$end_point$$ = 0)
	    AND   etn.external_database_release_id = blat.target_external_db_release_id
            AND   blat.max_target_gap < 10000
	    AND   (etn.source_id = $$chromosomeOptional$$
                   OR lower(etn.source_id) = lower($$sequenceId$$))
            AND blat.target_start >= $$start_point$$ 
            AND (blat.target_end <= $$end_point$$ OR $$end_point$$ = 0)
	    GROUP BY est.accession
           ]]>
       </sql>
    </sqlQuery>

    <wsQuery name="EstsByLocation" includeProjects="ApiDB" 
          isCacheable="true" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withChromosomes"/>
        <paramRef ref="sharedParams.chromosomeOptional"/>
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sharedParams.libraryId"/>
        <paramRef ref="sharedParams.best_alignment_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.high_confidence_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_identity" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_est_aligned" groupRef="paramGroups.advancedParams"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </wsQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Library  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstsByLibrary" excludeProjects="ApiDB" 
             isCacheable='true'>
        <paramRef ref="sharedParams.libraryId"/>
        <column name="source_id" />
        <column name="project_id"/>
        <sql>
            SELECT enas.source_id, '@PROJECT_ID@' as project_id
            FROM dots.nasequence enas, dots.est e
            WHERE enas.na_sequence_id = e.na_sequence_id
            AND e.library_id in ($$libraryId$$)
       </sql>
    </sqlQuery>

    <wsQuery name="EstsByLibrary" includeProjects="ApiDB" 
             displayName="Library Name" isCacheable='true' 
             processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" >
        <paramRef ref="sharedParams.libraryId"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </wsQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Gene Overlap  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstsWithGeneOverlap" excludeProjects="ApiDB"
            isCacheable='true'>
       <paramRef ref="sharedParams.libraryId"/>
       <paramRef ref="sharedParams.bp_overlap_gte"/>
       <paramRef ref="estParams.overlapOrNot"/>
       <paramRef ref="sharedParams.best_alignment_only" excludeProjects="CryptoDB"
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.high_confidence_only" excludeProjects="CryptoDB"
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.min_percent_identity" excludeProjects="CryptoDB"
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.min_percent_est_aligned" excludeProjects="CryptoDB"
             groupRef="paramGroups.advancedParams"/>
       <column name="source_id" />
       <column name="project_id"/>
       <column name="est_locations"  excludeProjects="CryptoDB"/>
       <column name="genes"  excludeProjects="CryptoDB"/>
       <sql excludeProjects="CryptoDB">
            <![CDATA[
              SELECT accession as source_id, '@PROJECT_ID@' as project_id,
                  apidb.tab_to_string(
                    CAST(
                      COLLECT(target_sequence_source_id || ':'
                      || trim(to_char(target_start,'999,999,999'))
                      || '-' || trim(to_char(target_end,'999,999,999'))
                      || '(' || decode(is_reversed,0,'+',1,'-',null) || ')')
                    AS apidb.varchartab), ', ') AS est_locations,
                  apidb.tab_to_string(CAST(COLLECT(gene) 
                                      AS apidb.varchartab), ', ') as genes
	    FROM (
                SELECT accession,gene ,target_start,target_end, is_reversed, target_sequence_source_id
                FROM apidb.ESTALIGNMENTGENESUMMARY
                WHERE is_consistent in ($$high_confidence_only$$)
                AND is_best_alignment in ($$best_alignment_only$$)
                AND percent_identity >= $$min_percent_identity$$
                AND percent_est_bases_aligned >= $$min_percent_est_aligned$$
                AND library_id in ($$libraryId$$)
             $$overlapOrNot$$                    
               SELECT i.accession,i.gene ,i.target_start,i.target_end, i.is_reversed, i.target_sequence_source_id
                FROM apidb.ESTALIGNMENTGENESUMMARY i
                WHERE i.est_gene_overlap_length >= $$bp_overlap_gte$$
                AND is_consistent in ($$high_confidence_only$$)
                AND is_best_alignment in ($$best_alignment_only$$)
                AND percent_identity >= $$min_percent_identity$$
                AND percent_est_bases_aligned >= $$min_percent_est_aligned$$
                AND library_id in ($$libraryId$$)
            )          
            GROUP BY accession
           ]]>
       </sql>

        <sql includeProjects="CryptoDB">
            <!-- query result includes 11 ests that have no genomic alignment -->
            <![CDATA[
            SELECT accession as source_id, '@PROJECT_ID@' as project_id 
              FROM dots.est where est_id $$overlapOrNot$$ (
                SELECT distinct(e.est_id)
                FROM dots.genefeature gf, core.tableinfo info,
                dots.nalocation nal, dots.blatalignment blat, 
                dots.est e, dots.nasequence enas2 
                WHERE gf.na_feature_id = nal.na_feature_id 
                AND gf.na_sequence_id = enas2.na_sequence_id 
                AND enas2.na_sequence_id = blat.target_na_sequence_id 
                AND e.na_sequence_id = blat.QUERY_NA_SEQUENCE_ID 
                AND (blat.TARGET_END - nal.start_max) >= $$bp_overlap_gte$$  
                AND (nal.end_min - blat.TARGET_START) >= $$bp_overlap_gte$$  
                AND (query_end - query_start) >= $$bp_overlap_gte$$  
                AND blat.max_target_gap < 10000 
                AND blat.is_best_alignment = 1
                AND blat.query_table_id = info.table_id
                AND info.name = 'AssemblySequence'
                AND e.library_id in ($$libraryId$$)
            ) 
            AND library_id in ($$libraryId$$)
           ]]>
       </sql>
    </sqlQuery>


    <wsQuery name="EstsWithGeneOverlap" includeProjects="ApiDB"
       isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sharedParams.libraryId"/>
       <paramRef ref="sharedParams.bp_overlap_gte"/>
       <paramRef ref="estParams.overlapOrNot"/>
       <wsColumn name="source_id" width="60" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
    </wsQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- BLAST  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <wsQuery name="EstsBySimilarity" excludeProjects="ApiDB"
             displayName="BLAST"
             processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">
       <paramRef ref="estParams.BlastDatabaseType"/>
       <paramRef ref="estSimilarityParams.BlastDatabaseOrganism"/>
       <paramRef ref="sharedParams.BlastQueryType"/>
       <paramRef ref="sharedParams.BlastQuerySequence"/>
       <paramRef ref="sharedParams.-e"/>
       <paramRef ref="sharedParams.-v"/>
       <paramRef ref="sharedParams.-b"/>
       <paramRef ref="sharedParams.-filter"/>
       <wsColumn name="source_id" width="32" wsName="Identifier"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="TabularRow" width="3000"/>
       <wsColumn name="Alignment" width="4000"/>
       <wsColumn name="Header" width="3000"/>
       <wsColumn name="Footer" width="3000"/>
    </wsQuery>

    <wsQuery name="EstsBySimilarity" includeProjects="ApiDB"
         displayName="BLAST ESTs" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="estParams.BlastDatabaseType"/>
       <paramRef ref="estSimilarityParams.BlastDatabaseOrganism"/>
       <paramRef ref="sharedParams.BlastQueryType"/>
       <paramRef ref="sharedParams.BlastQuerySequence"/>
       <paramRef ref="sharedParams.-e"/>
       <paramRef ref="sharedParams.-v"/>
       <paramRef ref="sharedParams.-b"/>
       <paramRef ref="sharedParams.-filter"/>
       <wsColumn name="source_id" width="60" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="TabularRow" width="3000"/>
       <wsColumn name="Alignment" width="4000"/>
       <wsColumn name="Header" width="3000"/>
       <wsColumn name="Footer" width="3000"/>
    </wsQuery>


  </querySet>
</wdkModel>
