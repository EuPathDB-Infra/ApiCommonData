<wdkModel>

  <querySet name="SageTagIds">


    <sqlQuery name="ByRStat" includeProjects="GiardiaDB,ToxoDB,PlasmoDB"
              isCacheable="true">
       <paramRef ref="geneParams.sage_tag_library_name"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="R"/>
       <sql>
         <![CDATA[
       select source_id,
              '@PROJECT_ID@' as project_id, 
              to_char(sum(xij * log(10, (xij/(Ni * fj)))), '99999D0') as R
       from (
         select a.source_id, aa.library_name, library_count.n as ni, f.frequency as fj, sum(aa.raw_count) as xij
         from apidb.SAGETAGANALYSISATTRIBUTES aa, 
              apidb.SAGETAGATTRIBUTES a,
              (select a.source_id, sum(aa.raw_count) / max(n.n) as frequency
               from apidb.SAGETAGANALYSISATTRIBUTES aa, 
               apidb.SAGETAGATTRIBUTES a,
               (select sum(max(total_raw_count)) as n
                from apidb.SAGETAGANALYSISATTRIBUTES
                where library_name in ($$sage_tag_library_name$$)
                group by library_name) n
               where aa.library_name in ($$sage_tag_library_name$$)
                and aa.composite_element_id = a.composite_element_id
               group by a.source_id) f,
              (select library_name, max(total_raw_count) as n
               from apidb.SAGETAGANALYSISATTRIBUTES
               where library_name in ($$sage_tag_library_name$$)
               group by library_name) library_count
         where aa.composite_element_id = a.composite_element_id
          and a.source_id = f.source_id
          and aa.library_name = library_count.library_name
         group by a.source_id, aa.library_name, library_count.n, f.frequency
         )
       group by source_id
       having sum(xij * log(10, (xij/(Ni * fj)))) >  $$sage_tag_min_r$$
         ]]>
       </sql>
    </sqlQuery>

<wsQuery name="ByRStat" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

      <paramRef ref="geneParams.sage_tag_library_name"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="R"/>

 </wsQuery> 



    <sqlQuery name="ByLocation" includeProjects="GiardiaDB,PlasmoDB"
              isCacheable="true">
        <paramRef includeProjects="Giardia" ref="sharedParams.sequenceId"/>
        <paramRef includeProjects="PlasmoDB" ref="sharedParams.chromosome"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="dynamic_location"/>
       <sql includeProjects="GiardiaDB">
         <![CDATA[
            select distinct sta.source_id as source_id, '@PROJECT_ID@' as project_id,
              a.sequence_source_id || ': ' || trim(to_char(a.start_min,'999,999,999')) || ' - ' || trim(to_char(a.end_max,'999,999,999')) || decode(a.is_reversed, 1, ' (-)', ' (+)') as dynamic_location
            from apidb.sagetagattributes sta, apidb.featurelocation a left join apidb.SAGETAGGENE sg
                  on a.na_feature_id = sg.tag_feature_id and sg.distance = 0 and sg.antisense = 0
            where lower(a.sequence_source_id) = lower($$sequenceId$$)
              AND  a.feature_type = 'SAGETagFeature'
              AND  a.end_max >=  $$start_point$$
              AND  (a.start_min <=  $$end_point$$ OR  $$end_point$$ = 0)
              AND  sta.na_feature_id = a.na_feature_id
              AND (sg.gene_source_id is $$is_within_gene_not$$ null OR sg.gene_source_id is not null)
         ]]>
       </sql>
       <sql includeProjects="PlasmoDB">
         <![CDATA[
            select distinct sta.source_id as source_id, '@PROJECT_ID@' as project_id,
              a.sequence_source_id || ': ' || trim(to_char(a.start_min,'999,999,999')) || ' - ' || trim(to_char(a.end_max,'999,999,999')) || decode(a.is_reversed, 1, ' (-)', ' (+)') as dynamic_location
            from apidb.sagetagattributes sta, apidb.featurelocation a left join apidb.SAGETAGGENE sg
                  on a.na_feature_id = sg.tag_feature_id and sg.distance = 0 and sg.antisense = 0
            where lower(a.sequence_source_id) = lower($$chromosome$$)
              AND  a.feature_type = 'SAGETagFeature'
              AND  a.end_max >=  $$start_point$$
              AND  (a.start_min <=  $$end_point$$ OR  $$end_point$$ = 0)
              AND  sta.na_feature_id = a.na_feature_id
              AND (sg.gene_source_id is $$is_within_gene_not$$ null OR sg.gene_source_id is not null)
         ]]>
       </sql>
    </sqlQuery>

<wsQuery name="ByLocation" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

        <paramRef includeProjects="GiardiaDB" ref="sharedParams.sequenceId" default="CH991779"/>
        <paramRef includeProjects="PlasmoDB" ref="sharedParams.chromosome" default="P.f. chromosome 1"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="dynamic_location" width="100" wsName="dynamic_location"/>
  </wsQuery> 


    <sqlQuery name="BySequence" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.sequence"/>
        <paramRef ref="sageTagParams.is_within_gene"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id 
         from apidb.SageTagAttributes a, apidb.SageTagGene sg
         where (lower(a.sequence) = lower($$sequence$$) 
                 OR lower('catg' || a.sequence) = lower($$sequence$$) )
         and a.na_feature_id = sg.tag_feature_id $$is_within_gene$$ 
         ]]>
       </sql>
    </sqlQuery>

<wsQuery name="BySequence" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.sequence"/>
       <paramRef ref="sageTagParams.is_within_gene"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
  </wsQuery> 

 
    <sqlQuery name="ByGeneSourceId" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.single_gene_id"/>
        <paramRef ref="geneParams.st_max_five_prime_distance"/>
        <paramRef ref="geneParams.st_max_three_prime_distance"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from apidb.SageTagAttributes a, apidb.SageTagGene sg
         where a.na_feature_id = sg.tag_feature_id
         and sg.antisense = 0
         and sg.gene_source_id LIKE REGEXP_REPLACE(REPLACE($$single_gene_id$$,'*', '%'),'[[:space:]]', '')
         and ((sg.direction = '5' and sg.distance <= $$st_max_five_prime_distance$$)
             OR (sg.direction = '3' and sg.distance <= $$st_max_three_prime_distance$$))
         ]]>
       </sql>
</sqlQuery>
 
<wsQuery name="ByGeneSourceId" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.single_gene_id"/>
       <paramRef ref="geneParams.st_max_five_prime_distance"/>
       <paramRef ref="geneParams.st_max_three_prime_distance"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </wsQuery> 

  
 <sqlQuery name="ByRadSourceId" includeProjects="GiardiaDB,PlasmoDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.rad_source_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from apidb.SageTagAttributes a, @LOGIN_SCHEMA@dataset_values@LOGIN_DBLINK@ ds
         where ds.dataset_id = $$rad_source_id$$
           and (a.rad_source_id is null -- as in the case of plasmodb 5.5
             or a.rad_source_id LIKE REGEXP_REPLACE(REPLACE(ds.dataset_value,'*', '%'),'[[:space:]]', ''))
           and a.source_id LIKE REGEXP_REPLACE(REPLACE(ds.dataset_value,'*', '%'),'[[:space:]]', '')
         ]]>
       </sql>
</sqlQuery>

 <wsQuery name="ByRadSourceId" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.rad_source_id"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </wsQuery> 


 <sqlQuery name="ByExpressionLevel" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.st_min_count"/>
        <paramRef ref="sageTagParams.raw_normalized"/>
        <paramRef ref="sageTagParams.sage_experiment"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="tag_count" />
        <column name="tag_percentage" />
        <column name="raw_count" />
        <column name="raw_percentage" />
        <column name="SAGE_library" />
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id,to_char(staa.tag_count, '99999') as tag_count, to_char(staa.raw_count , '99999') as raw_count,
         to_char(staa.library_tag_percentage,'990D00') || '%' as tag_percentage,
         to_char(staa.raw_percent,'990D00') || '%' as raw_percentage,
         staa.library_name as SAGE_library
         from apidb.SageTagAttributes a, apidb.SageTagAnalysisAttributes staa
         where (CASE '$$raw_normalized$$' WHEN 'n' THEN staa.tag_count ELSE staa.raw_count END)>= $$st_min_count$$ 
         and staa.library_name = $$sage_experiment$$
         and a.composite_element_id=staa.composite_element_id
         ]]>
       </sql>
</sqlQuery>

<wsQuery name="ByExpressionLevel" includeProjects="ApiDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.st_min_count"/>
       <paramRef ref="sageTagParams.raw_normalized"/>
       <paramRef ref="sageTagParams.sage_experiment"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>

       <wsColumn name="tag_count" width="32" wsName="tag_count" />
       <wsColumn name="tag_percentage" width="32" wsName="tag_percentage"/>
       <wsColumn name="raw_count" width="32" wsName="raw_count"/>
       <wsColumn name="raw_percentage" width="32" wsName="raw_percentage"/>
       <wsColumn name="SAGE_library" width="100" wsName="SAGE_library"/>
   </wsQuery>

  </querySet>

</wdkModel>
