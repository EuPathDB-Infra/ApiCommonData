#!/usr/bin/perl

use strict;
use warnings;

use Bio::SeqIO;
use Getopt::Long;

my (@protFiles,$nrFile);

&GetOptions("protFile=s" => \@protFiles,
	    "nrFile=s" => \$nrFile,
            );

unless (@protFiles && -e $nrFile){ die "You must provide a valid protein file and a valid nr file. Usage: mapGenBankAccessions --protFile <FILE> --nrFile <FILE>";}

foreach my $protFile (@protFiles){
  die "Could not find file '$protFile': $!\n" unless (-e $protFile);

  my %proteins;
  my $proteins = Bio::SeqIO->new(-file => $protFile,
				 -format => "fasta");

  while (my $protein = $proteins->next_seq()) {
    push(@{$proteins{uc($protein->seq())}}, $protein->display_id());
  }

  my $nr = Bio::SeqIO->new(-file => $nrFile, -format => "fasta");

  while(my $seq = $nr->next_seq()) {
    if($proteins{uc($seq->seq())}) {

      my @sourceIds = @{$proteins{uc($seq->seq())}};
      my @gi = $seq->display_id() =~ m/gi\|(\d+)/;

      while (m/\001gi\|(\d+)/g) {
	push @gi, $1;
      }

      for my $sourceId (@sourceIds){
	$sourceId =~ s/-1//;
	for my $gi (@gi) {
	  print "$sourceId\t$gi\n";
	}
      }

    }
  }

}
