#!/usr/bin/perl

# shortens the NRDB deflines to the first gi number (cuts at the first space)

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";

use Getopt::Long qw(GetOptions);
use GUS::ObjRelP::DbiDatabase;
use GUS::Supported::GusConfig;


my $inputFile;
my $outputFile;
my $taxonIdMappingFile;
my $newDefLine;
my $gusConfigFile;
my $verbose = 0;

GetOptions("inputFile=s"     => \$inputFile,
           "outputFile=s"    => \$outputFile,
	   "taxonIdMappingFile=s"    => \$taxonIdMappingFile,
          );

unless (-e $inputFile) {
  die "\nERROR:  Must supply a valid input file!\nUsage: shortenDefLine --inputFile <FILE> --outputFile <FILE>\n\nPURPOSE: shortens the NRDB deflines to the first gi number (cuts at the first space) so that BLAST doesn't choke on the return strings.\n";
}


my $gusConfig = GUS::Supported::GusConfig->new($gusConfigFile);

my $dbh = GUS::ObjRelP::DbiDatabase->new($gusConfig->getDbiDsn(),
                                         $gusConfig->getDatabaseLogin(),
                                         $gusConfig->getDatabasePassword(),
                                         $verbose, 0, 1,
                                         $gusConfig->getCoreSchemaName()
                                        )->getQueryHandle();


  $dbh->do("DROP TABLE gi2ncbiTaxonId");
  $dbh->do(<<EOSQL);
  CREATE TABLE gi2ncbiTaxonId(
    gi INTEGER NOT NULL,
    ncbiTaxonId INTEGER NOT NULL
  ) NOLOGGING
EOSQL

  $dbh->do(<<EOSQL);
  CREATE INDEX gi2ncbiTaxonId_ix ON gi2ncbiTaxonId (gi, ncbiTaxonId)
EOSQL

  my $insertSql = $dbh->prepare(<<EOSQL);
  INSERT INTO gi2ncbiTaxonId (gi, ncbiTaxonId)
            VALUES (        ?,      ?)
EOSQL

  my $searchSql = $dbh->prepare(<<EOSQL);
  SELECT ncbiTaxonId
  FROM   gi2ncbiTaxonId
  WHERE  gi = ?
EOSQL

if ($taxonIdMappingFile){

    open(MAPPING, "< $taxonIdMappingFile")|| die "File not found\n";

    while(<MAPPING>){
	    if (/^(\d+)\s(\d+)/){
		$insertSql->execute($1, $2);
	    }

    }
    close MAPPING;
}

open(IN, "< $inputFile");
open(OUT, "> $outputFile");

while(<IN>){
	if(/(^\>gi\S+)/){
	    $newDefLine = $1;
	}else{
	    $newDefLine = $_;
	}
	if ($newDefLine =~ /^\>gi\|(\d+)\|/){
	    $searchSql->execute($1);
	    my $ncbiTaxonId = $searchSql->fetchrow_array();
	    if ($ncbiTaxonId){
		$newDefLine .= "|$ncbiTaxonId|\n" ;
	    }elsif ($taxonIdMappingFile) {
		$newDefLine .= "|32644|\n" ;
	    }else {
		$newDefLine .= "\n" ;
	    }
        }
	print OUT $newDefLine;
}

close IN;
close OUT;

$dbh->do("DROP TABLE gi2ncbiTaxonId");
