#!/usr/bin/perl

# given a fasta file with proteins and a GFF file with transcript 
# features that correspond to the proteins, append a Protein attribute
# to the transcript features in the GFF

# NOTE: this is a simple program that assumes that the fasta sequence
# can fit in memory


use strict;

my $proteinFile = $ARGV[0];
my $gffFile = $ARGV[1];

if (!$proteinFile || !$gffFile) {
  die "usage:  addProteinsToGff protein_fasta_file gff_file\n";
}

open(FASTA, $proteinFile) || die "couldn't open fasta file '$proteinFile'\n";

my $line = <FASTA>;
my $id = &getId($line);
my $seq = "";
my %proteins;
while (<FASTA>) {
  chomp;
  if (/\>/) {
    $proteins{$id} = $seq;
    $id = getId($_);
    $seq = "";
  } else {
    $seq .= $_;
  }
}
$proteins{$id} = $seq;


open(GFF, $gffFile) || die "can't open gff file '$gffFile'\n";

while (<GFF>) {
  chomp;
  my $line = $_;
  if (/transcript/) {
    $line =~ /GenePrediction \"([^\"]+)\"/;
    my $id = $1;
    $proteins{$id} || die "couldn't find a protein for '$id'\n";
    $line .= " ; Protein $proteins{$id}";
  }
  print "$line\n";
}

sub getId {
  my ($line) = @_;

  my @fields = split(/\|/, $line);
  $fields[0] =~ /\>(\S+)\s*/;
  my $id = $1
}

