#!/usr/bin/perl

use strict;
use warnings;
use lib "$ENV{GUS_HOME}/lib/perl";
use Getopt::Long;
use GUS::ObjRelP::DbiDatabase;
use CBIL::Util::PropertySet;
#use List::MoreUtils qw { any };

use Data::Dumper;

my ($gusConfigFile, $snpSampleExtDbRlsId, $sampleName, $experimentName, $organismAbbrev, $projectName);
&GetOptions("gusConfigFile=s" => \$gusConfigFile,
            "snpSampleExtDbRlsId=i" => \$snpSampleExtDbRlsId,
            "sampleName=s" => \$sampleName,
            "experimentName=s" => \$experimentName,
            "organismAbbrev=s" => \$organismAbbrev,
            "projectName=s" => \$projectName);

if (!$snpSampleExtDbRlsId || !$sampleName || !$experimentName || !$organismAbbrev || !$projectName){
    die "usage: cnvWorkflowCheckpoint --snpSampleExtDbRlsId <External database release id for the SNP sample> --sampleName <Name of sample> --experimentName <Experiment Name> --organismAbbrev <organismabbreviation> --projectName <Project name , e.g., PlasmoDB (--gusConfigFile(only required if not default)\n";
}


if (!$gusConfigFile) {
    $gusConfigFile = $ENV{GUS_HOME} ."/config/gus.config"; 
}

my @properties = ();

die "Config file $gusConfigFile does not exist. " unless -e $gusConfigFile;

my $gusConfig = CBIL::Util::PropertySet->new($gusConfigFile, \@properties, 1);

my $db = GUS::ObjRelP::DbiDatabase->new($gusConfig->{props}->{dbiDsn},
                                        $gusConfig->{props}->{databaseLogin},
                                        $gusConfig->{props}->{databasePassword},
                                        0,0,1,
                                        $gusConfig->{props}->{coreSchemaName},
                                        );

my $dbh = $db->getQueryHandle();
my $sql = "select c.value from study.protocolappnode pan, study.characteristic c, sres.ontologyterm ot
           where pan.external_database_release_id = $snpSampleExtDbRlsId
           and c.protocol_app_node_id = pan.protocol_app_node_id
           and ot.name = 'average mapping coverage'
           and c.qualifier_id = ot.ontology_term_id";
my $stmt = $dbh->prepare($sql);
my $coverage = $dbh->selectrow_arrayref($stmt);
$stmt->finish();

if (scalar @{$coverage} >1) {
    die "More than one coverage metric was returned for sample $sampleName\n";
}

my $averageCoverage = $coverage->[0];
if ($averageCoverage < 6) {
    die "The average mapping coverage for sample $sampleName is $averageCoverage.\n\nSamples with less than 6x coverage will produce nonsensical data in the CNV workflow and may cause the workflow to fail.\n\n***Please undo the CNV workflow for sample $sampleName back to the beginning of the sample graph (step $organismAbbrev"."_copyNumberVariations_$experimentName.doCnvMapping.$sampleName"."_cnvSample) and remove the 'copyNumberVariationSamples' datasetclass for $sampleName from EuPathDatasets/Datasets/lib/xml/datasets/$projectName/$organismAbbrev/$experimentName.xml***\n";
} else {
    print "The average mapping coverage for sample $sampleName is $averageCoverage.\n\nThis sample will be run in the CNV workflow.\n";
}

exit;
