#!/usr/bin/perl -w
#
use LWP::Simple;
use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use DBI;
use DBD::Oracle;
use CBIL::Util::PropertySet;


$| = 1;

my $PRINT_URLS = 1;

my ($outputFile, $organismAbbrev) = @ARGV;

my $parentNcbiTaxonIds;
if (!$organismAbbrev) {
    $parentNcbiTaxonIds = chomp(<STDIN>);
}

die "Must provide either an organismAbbrev on command line or parent taxon IDs on stdin\n" unless $organismAbbrev || $ncbiTaxonIds;

die "Output file '$outputFile' already exists\n" if -e $outputFile;

my $db      = "nuccore";
my $utils = "http://www.ncbi.nlm.nih.gov/entrez/eutils";


# use eutils to run query at ncbi.  returns a handle on a set of records
my $query = buildQueryString($organismAbbrev, $parentNcbiTaxonIds);
my $esearch = "$utils/esearch.fcgi?db=$db&retmax=1&usehistory=y&term=";
my $esearch_result = get("$esearch$query");
print STDERR "$esearch$query\n\n" if $PRINT_URLS;
die "Failed running esearch query" unless defined $esearch_result;

$esearch_result =~ m|<Count>(\d+)</Count>.*<QueryKey>(\d+)</QueryKey>.*<WebEnv>(\S+)</WebEnv>|s || die "Can't parse results from esearch\n";

# We matched $Count genbank records.  We can get them using $QueryKey and
# $WebEnv as IDs for our query result
my $Count    = $1;
my $QueryKey = $2;
my $WebEnv   = $3;

print STDERR "Query found $Count genbank records\n";

exit(0) unless $Count;

# assume we can fit all these results easily in memory
my $efetch = "$utils/esummary.fcgi?db=$db&query_key=$QueryKey&WebEnv=$WebEnv";

print STDERR "$efetch\n\n" if $PRINT_URLS;
my $efetch_result = get($efetch);
open(FF,">/home/sfischer/junk/gbyuck");
print FF $efetch_result;
close(FF);

die "Failed getting efetch result\n" unless $efetch_result;

my $batchSize = 100;

my @uniqueAccs = $efetch_result =~ /\<Id\>(\d+)/g; # (actually gi's)

my $uniqueAccCount = scalar(@uniqueAccs);

print STDERR "found $uniqueAccCount unique genbank Ids\n";
my $batchCount = int($uniqueAccCount / $batchSize + 1);

# group the GIs into batches, to reduce internet accesses.
my @batches;
my $totcount;
for (my $i=0; $i<$batchCount; $i++) {
  my $sliceStart = $i*$batchSize;
  my $sliceEnd = ($i+1)*$batchSize-1;
  $sliceEnd = $#uniqueAccs if $sliceEnd > $#uniqueAccs;
  my @tmp = @uniqueAccs[$sliceStart .. $sliceEnd];
  $batches[$i] = join(",", @tmp) if (scalar @tmp>0);
}

foreach my $batch (@batches) {
  print STDERR ".";
  my $url = "$utils/efetch.fcgi?db=$db&id=$batch&rettype=gb&retmode=text";
  my $gb_result = get($url);
  print STDERR "\n$url\n\n" if $PRINT_URLS;

  die "Failed getting gb result\n" unless $gb_result;
  open(FILE, ">>$outputFile") || die "Could not open output file '$outputFile'\n";
  print FILE "$gb_result";
  close(FILE);
}


print STDERR "\nFetched " . scalar(@batches) . " isolate batches containing $uniqueAccCount unique isolate records.\n";


sub usage {
  print STDERR "

Use NCBI's eutils to fetch isolate sequences from genbank.  All sequences
are concatenated into a single genbank file.  Gets isolates for all NCBI
taxon IDs that are *children* of the provided ncbiTaxonIds (including
those provided).

Takes a comma delimited list of taxon IDs on stdin.

usage: 
  getIsolatesFromGenbank outputfile organismAbbrev
  echo '12433,7680' | getIsolatesFromGenbank outputFile

(Prints a . to STDERR for each batch of sequences it gets.)

";

  exit(1);

}

sub buildQueryString {
  my ($organismAbbrev, $parentNcbiTaxonIds) = @_;

  my $gusConfigFile = "$ENV{GUS_HOME}/config/gus.config";
  my @properties = ();
  my $gusconfig = CBIL::Util::PropertySet->new($gusConfigFile, \@properties, 1);
  my $u = $gusconfig->{props}->{databaseLogin};
  my $pw = $gusconfig->{props}->{databasePassword};
  my $dsn = $gusconfig->{props}->{dbiDsn};
  my $dbh = DBI->connect($dsn, $u, $pw) or die DBI::errstr;
  $dbh->{RaiseError} = 1;

  # either get parent ncbi taxon ids from organism table or stdin
  my $inStmt = "
     select familyNcbiTaxonIds
     from apidb.organism
     where organismAbbrev = '$organismAbbrev'";

  $inStmt = $parentNcbiTaxonIds if $parentNcbiTaxonIds;

  my $sql = <<SQL;
  select ncbi_tax_id
  from SRes.Taxon, apidb.organism
  start with ncbi_tax_id in ($inStmt)
  connect by prior taxon_id = parent_id
SQL

  my $stmt = $dbh->prepare($sql);
  $stmt->execute();

  my %ncbiTaxIds;
  while (my($currentTaxon) = $stmt->fetchrow_array()) {
    $ncbiTaxIds{$currentTaxon} = 1;
    print STDERR "including NCBI taxon id $currentTaxon\n";
  }

  my @queries = map {"(((txid${_}[Organism:exp]) AND (isolate)) NOT (genome))"} keys(%ncbiTaxIds);
  my $query = join("OR", @queries);
  return $query;
}
