#!/usr/bin/perl
use strict;

my $glossaryTabFile = $ARGV[0];
&usage() unless $glossaryTabFile;

open(FILE, $glossaryTabFile) || die "can't open file '$glossaryTabFile'\n";

# firt pass, make hash
my $glossHash;
my $glossArray;
while(<FILE>) {
    chomp;
    my ($term,$def) = split(/\t/);
    next unless $term;
    $glossHash->{$term} = $def;
    push(@$glossArray, $term);
}

# embed links in definitions where they include references to other terms
print qq{<?xml version="1.0" encoding="UTF-8"?>

<!-- DO NOT EDIT THIS FILE!!  see ../glossary_README.txt  -->

<xmlAnswer>
};

foreach my $term (@$glossArray) {

    # make links pointing to other entries in the glossary
    foreach my $term2 (keys %$glossHash) {
	next if $term2 eq $term;
	next if $term2 eq 'Gene';  # just too common 
	my $link = "<a href=\"#${term2}\">${term2}</a>";
	# in following regex, avoid making substitution into links
	# and, handle case insensitivity, plural and parantheses 
	$glossHash->{$term} =~ s/([\s\W|\s])($term2)(s?)(\W)/$1<a href=\"#$term2\">$2$3<\/a>$4/gi;
    }
    
    my $wdkString = qq{
   <record>
       <attribute name="term">$term</attribute>
       <attribute name="definition">
         <![CDATA[
$glossHash->{$term}
          ]]>
       </attribute>
    </record>

};
    print $wdkString;
}

print "</xmlAnswer>\n";

sub usage {
    print "
convert glossary file in tab-delimited text to wdk record xml

usage:glossaryTextToXml tabfile

";
    exit(1);
}
