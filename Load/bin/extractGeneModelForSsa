#!/usr/bin/perl

use strict;
use DBI;
use Bio::SeqFeature::Gene::Exon;
use CBIL::Util::PropertySet;
use Getopt::Long;

#----------------Get UID and PWD/ database handle---------------

my ($verbose,$gusConfigFile,$outputFile,$taxonId);

&GetOptions("verbose!" => \$verbose,
            "outputFile=s" => \$outputFile,
            "gusConfigFile=s" => \$gusConfigFile,
            "taxonId=s" => \$taxonId,
	    );


$gusConfigFile = $ENV{GUS_HOME} . "/config/gus.config" unless($gusConfigFile);

unless(-e $gusConfigFile) {
  print STDERR "gus.config file not found! \n";
  exit;
}


my @properties = ();
my $gusconfig = CBIL::Util::PropertySet->new($gusConfigFile, \@properties, 1);

my $u = $gusconfig->{props}->{databaseLogin};
my $pw = $gusconfig->{props}->{databasePassword};
my $dsn = $gusconfig->{props}->{dbiDsn};

my $dbh = DBI->connect($dsn, $u, $pw) ||  die "Couldn't connect to database: " . DBI->errstr;
$dbh->{RaiseError} = 1;
$dbh->{AutoCommit} = 0;


my ($species,$indexFile,$geneFastaFile,$seqFastaFile);


#------------------------------


   open(OUTINDX,">$outputFile");

  print("Preparing to export genes model for Ssa...\n");

  my $GeneQuery = &GetGeneQuery($taxonId);

      my $handle;
  my $sth = $$handle->prepare($GeneQuery) || die "Couldn't prepare the SQL statement: " . $$handle->errstr;  
  $sth->execute ||  die "Couldn't execute statement: " . $sth->errstr;


  while (my  $resultset = $sth->fetchrow_hashref) {

      print OUTINDX $resultset->{SEQUENCE_ID}."\t".$resultset->{STRAND}."\t".$resultset->{START_MIN}."\t".$resultset->{END_MAX}."\t".$resultset->{EXON_COUNT}."\t";

      my $ExonQuery = &GetExonQuery($resultset->{NA_FEATURE_ID});
  
      my $handle2;
       my $sth2 = $$handle2->prepare($ExonQuery) || die "Couldn't prepare the SQL statement: " . $$handle2->errstr;  
      $sth2->execute ||  die "Couldn't execute statement: " . $sth2->errstr;


      my ($exonStarts,$exonEnds);
      while (my  $resultset2 = $sth2->fetchrow_hashref) {
	  $exonStarts .= $resultset2->{START_MIN}.",";
	  $exonEnds .= $resultset2->{END_MAX}.",";
      }

      print OUTINDX "$exonStarts\t$exonEnds\t".$resultset->{SOURCE_ID}."\n";

  }

      close(OUTINDX);

 
$dbh->disconnect;



#----------SUBROUTINES------------------#


#--------QUERIES-----------------#


sub GetGeneQuery {

  my ($TaxonID) = @_;

  return ("SELECT sequence_id,
                  source_id,
                  na_feature_id,
                  start_min -1,
                  end_max,
                  decode(is_reversed, 1, '-', '+') as strand, 
                  exon_count

           FROM   ApiDB.GeneAttributes,
                 
           WHERE  
                   taxon_id in ($TaxonID)
           ORDER BY chromosome_order_num,sequence_id,start_min,end_max,source_id");
  


}
sub GetExonQuery {

  my ($parentID) = @_;

  return ("SELECT 
                  start_min,
                  end_max
           FROM   ApiDB.FeatureLocation

           WHERE  feature_type='ExonFeature'
           AND parent_id in ($parentID)
           ORDER BY start_min,end_max");
}


