#!/usr/bin/perl

use lib "$ENV{GUS_HOME}/lib/perl";
use ApiCommonData::Load::CalculationsForCNVs;
use strict;
use warnings;
use Getopt::Long;

our @ISA = qw(ApiCommonData::Load::CalculationsForCNVs);

# get parameter values
my $outputDir;
my $fpkm;
my $ploidy = 2;
my $sampleName;
my $taxonId;

&GetOptions("outputDir|o=s" => \$outputDir,
            "fpkmFile|f=s" => \$fpkm,
            "ploidy|p=i" => \$ploidy,
            "sampleName|s=s" => \$sampleName,
            "taxonId|s=i" => \$taxonId,
            );

&usage() unless ($outputDir && $fpkm && $sampleName && $taxonId);


die "File of FPKM values $fpkm not found\n" unless (-e $fpkm); 

my $chrPloidies = &calculateChrPloidies ($fpkm, $ploidy, $taxonId);

open (OUT, ">$outputDir/$sampleName\_Ploidy.txt") or die "Cannot open $outputDir/$sampleName\_Ploidy.tsv for writing\n$!\n";
printf OUT "na_sequence_id\tchr_copy_number\n";
foreach my $chr (keys %{$chrPloidies}) {
    printf OUT "%s\t%d\n", $chr, $chrPloidies->{$chr};
}
close OUT;

sub calculateChrPloidies {
    my ($fpkmFile, $ploidy, $taxonId) = @_;
    my $chrs = ApiCommonData::Load::CalculationsForCNVs::getChrsForCalcs($taxonId);
    my $chrValues = ApiCommonData::Load::CalculationsForCNVs::getChrFPKMVals($fpkmFile, $chrs);
    my $chrMedians = ApiCommonData::Load::CalculationsForCNVs::getChrMedians($chrValues, $chrs);
    my $allChrMedian = ApiCommonData::Load::CalculationsForCNVs::getMedianAcrossChrs($chrValues, $chrs);
    my $chrPloidies = ApiCommonData::Load::CalculationsForCNVs::getChrPloidies ($chrMedians, $allChrMedian, $ploidy, $chrs);
    return $chrPloidies;
}
    
sub usage {
    print STDERR "calculatePloidy --outputDir=s <dir to write output> --fpkm File=s <full path to genes.fpkm_tracking file generated by Cufflinks> --sampleName=s <sampleName used to name output files> --taxonId <taxonId for organism> [--ploidy=i <base ploidy> (expected ploidy for the majority of chromosomes - default is 2)]\n";
    exit;
}
exit;
