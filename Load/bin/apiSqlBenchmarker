#!/usr/bin/perl

use strict;
use DBI;

my ($configFile);

GetOptions("config=s" => \$configFile,
	  );

usage() unless $configFile;

open(F, $configFile) || die "Can't open config file '$configFile'\n";
my $config = {trackingDBI=> "",
	      trackingLogin=> "",
	      trackingPassword=> "",
	      project=> "",
	      appDBI=> "",
	      appLogin=> "",
	      appPassword=> "",
	      sql=> ""
	      description=> "",
	      nickname=> "",
	      hide=> "",
	      };

my $optionalConfig = {
	      description=> 1,
	      nickname=> 1,
	      hide=> 1,
	      };

my $processingSql;
my $sqlDelim = '===';
my $eofDelim = '###';
while (<F>) {
  next unless /\S/;
  last if /^$eofDelim/;
  if ($processingSql) {
    if (/^$sqlDelim/) {    # done processing sql
      $processingSql = 0;
    } else {
      $config->{sql} . = $_;
    }
  } else {
    if (/^$sqlDelim/) {
      $processingSql = 1; # start processing sql
    } else {
      chomp;
      /(\w+)\=(\S+)/;
      $config->{$1} = $2;
    }
  }
}

# validate the configuration
if (scalar($config) != 11) {
  print STDERR "ERROR: looks like you have an unsupported property in your config file\n\n";
  usage();
}

foreach my $prop () {
  if (!$config->{$prop} && !$optionalConfig->{$prop}) {
    print STDERR "ERROR: missing required property '$prop' in your config file\n\n";
  usage();
  }
}

my $trackerDbh = DBI->connect($config->{trackingDBI},
			      $config->{trackingLogin},
			      $config->{trackingPassword},
			      { PrintError => 1, RaiseError => 0}
			     )
  or die "Can't connect to the tracker database: $DBI::errstr\n";

my $appDbh = DBI->connect($config->{appDBI},
			  $config->{appLogin},
			  $config->{appPassword},
			  { PrintError => 1, RaiseError => 0}
			 )
  or die "Can't connect to the app database: $DBI::errstr\n";


###############################################################################

sub usage {
  print (
qq{
Usage:

apiSqlBenchmarking config_file

Config file format:

trackingDBI=
trackingLogin=
trackingPassword=
project=
appDBI=
appLogin=
appPassword=

$sqlDelim
select *
from whatever
where whatever
$sqlDelim

description=
nickname=
hide=

$eofDelim
});
  exit(1);
}


