#!/usr/bin/perl
use lib "$ENV{GUS_HOME}/lib/perl";
use strict;

use Getopt::Long;

use ApiCommonData::Load::IsolateVocabulary::Reader::VocabFileReader;

use ApiCommonData::Load::IsolateVocabulary::Reader::SqlTermReader;
use ApiCommonData::Load::IsolateVocabulary::Reader::XmlTermReader;

use ApiCommonData::Load::IsolateVocabulary::Reporter;
use ApiCommonData::Load::IsolateVocabulary::Utils;

my ($help, $gusConfigFile, $type, $xmlFile, $vocabFile);

&GetOptions('help|h' => \$help,
            'gus_config_file=s' => \$gusConfigFile,
            'type=s' => \$type,
            'xml_file=s' => \$xmlFile,
            'vocab_file=s' => \$vocabFile,
            );

&usage if($help);

$gusConfigFile = $ENV{GUS_HOME} . "/config/gus.config" unless($gusConfigFile);

if(!$gusConfigFile || !$type || !$xmlFile || !$vocabFile) {
  &usage("Error: Required Argument omitted");
}

my $dbh = ApiCommonData::Load::IsolateVocabulary::Utils::createDbh($gusConfigFile);

my $xmlReader = ApiCommonData::Load::IsolateVocabulary::Reader::XmlTermReader->new($xmlFile);
print STDERR "\nextracting terms from xml file\n";
my $xmlTerms = $xmlReader->extract();

my $vocabReader = ApiCommonData::Load::IsolateVocabulary::Reader::VocabFileReader->new($vocabFile);
print STDERR  "\ncollecting terms from vocabulary file\n";
my $vocabulary = $vocabReader->extract();

my $sqlTermReader = ApiCommonData::Load::IsolateVocabulary::Reader::SqlTermReader->new($dbh, $type, $vocabulary);
print STDERR "\nextracting isolate terms from the database\n";
my $vocabTerms = $sqlTermReader->extract();

my $reporter = ApiCommonData::Load::IsolateVocabulary::Reporter->new($gusConfigFile, $xmlTerms, $vocabTerms, $type, $vocabulary);
print STDERR "\nmaking report\n";
$reporter->report();

$dbh->disconnect();

sub usage {
  my ($m) = @_;

  print STDERR "$m\n\n" if($m);
  print STDERR "perl isolateVocabularyReport --type geographic_location|specific_host|isolation_source --xml_file xmlfile --vocab_file vocabfile [--gus_config_file gusconfigfile] \n";
  print STDERR "

Report terms used in isolates loaded into the database but not found in the provided vocabulary file.

";
  exit;
}
