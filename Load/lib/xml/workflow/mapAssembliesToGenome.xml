<workflowGraph name="mapAssembliesToGenome">

    <param name="parentDataDir"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="parentNcbiTaxonId"/>
    <param name="ncbiTaxonId"/>
    <param name="assembliesDataDir"/>
    <param name="genomicSeqsDir"/>
    
    <constant name ="dataDir">$$dataDir$$/mapAssemblies</constant>

    <step name="makeDataDir" class="ApiCommonData::Load::WorkflowSteps::MakeDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeClusterTaskDir" class="ApiCommonData::Load::WorkflowSteps::MakeGfClientInputDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <depends step="makeDataDir"/>
    </step>

    <step name="mirrorToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends step="makeClusterTaskDir"/>
    </step>

    <step name="startClusterTask" class="ApiCommonData::Load::WorkflowSteps::StartClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <paramValue name="queue">apidb</paramValue>
      <paramValue name="cmdName">runGenomeAlignWithGfClient</paramValue>
      <paramValue name="cmdArgs">$$assembliesDataDir$$/master/mainresult/blocked.seq,$$genomicSeqsDir$$</paramValue>
      <depends step="mirrorToCluster"/>
    </step>

    <step name="waitForClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <depends step="startClusterTask"/>
    </step>

    <step name="mirrorFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <depends step="waitForClusterTask"/>
    </step>

    <step name="insertBLATAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBLATAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryNcbiTaxId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assembliesDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends step="mirrorFromCluster"/>
    </step>

    <step name="setBestBlatAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBLATAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$parentncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assembliesDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends step="insertBlatAlignment"/>
    </step>

   <step name="updateAssemblySourceId"
          stepClass="ApiCommonData::Load::Steps::updateAssemblySourceId">
      <paramValue name="ncbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <depends step="setBestBlatAlignment"/>
    </step>
</workflowGraph>
