<workflow name="standardGenomeAnalysis">
  <params>
    <param name="genomeName"/>
    <param name="genomeExtDb"/>
    <param name="genomeExtDbRls"/>
    <param name="tigrVersion"/>
    <param name="soVersion"/>
    <param name="nrdbVersion"/>
    <param name="taxonomyVersion"/>
    <param name="ncbiTaxonId"/>
  </param>

  <constants>
    <constant name="Pf">Pfalciparum</constant>
    <constant name="Pb">Pberghei</constant>
    <constant name="Pv">Pvivax</constant>
    <constant name="Py">Pyoelii</constant>
    <constant name="genomeExtDbRlsSpec">${genomeExtDb}:${genomeExtDbRls}</constant>
    <constant name="soExtDbRlsSpec">SequenceOntology:${soVersion}</constant>
    <constant name="tigrExtDbRlsSpec">tigr:${tigrVersion}</constant>
    <constant name="taxonomyExtDbRlsSpec">tigr:${tigrVersion}</constant>
    <constant name="nrdbFile">seqfiles/nr.fsa</constant>
    <constant name="proteinsFile">seqfiles/${genomeName}AnnotatedProteins.fsa</constant>
    <constant name="genomicSeqsFile">seqfiles/${genomeName}GenomicSeqs.fsa</constant>
  </constants>

  <steps>
    <step name="NRDB" subflow="resource" global="true">
      <paramValue name="nrdbVersion">$$$nrdbVersion</paramValue>
      <paramValue name="nrdbFile">$$$nrdbFile</paramValue>
    </step>

    <step name="taxonomy" subflow="resource" global="true"/>
      <paramValue name="extDbRlsSpec">$$$taxonmyExtDbRlsSpec</paramValue>
    </step>

    <step name="SO" subflow="resource" global="true">
      <paramValue name="extDbRlsSpec">$$$soExtDbRlsSpec</paramValue>
    </step>

    <step name="genome" subflow="resource">
      <paramValue name="extDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
    </step>

    <step name="extractGenomicSeqs"
          class="ApiCommonData::Load::Steps::ExtractNaSeq">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="ncbiTaxId">$$$ncbiTaxonId</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="seqType">genomicSeqs</paramValue>
      <paramValue name="identifier">source_id</paramValue>
      <paramValue name="outputFile">$genomicSeqsFile</paramValue>
      <depends step="genome"/>
    </step>

    <step name="TIGR" subflow="resource">
      <paramValue name="extDbRlsSpec">$$$tigrExtDbRlsSpec</paramValue>
    </step>

    <step name="splign" subflow="splign">
      <include match="$genomeName" list="@@@Pf,@@@Pb,@@@Py,@@@Pv"/>
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$$tigrExtDbRlsSpec</paramValue>
      <depends step="genome"/>
      <depends step="TIGR"/>
    </step>

    <step name="calcTranslatedProteins"
          class="ApiCommonData::Load::Steps::CalculateTranslatedProteinSequence">
      <include match="$$$genomeName" list="@@@Pf,@@@Pb,@@@Py,@@@Pv"/>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="soExtDbRlsSpec">$$$soExtDbRlsSpec</paramValue>
      <depends step="genome"/>
    </step>

    <step name="extractProteins"
          class="ApiCommonData::Load::Steps::ExtractAnnotatedProteinsBySpecies">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="ncbiTaxId">$$$ncbiTaxonId</paramValue>
      <paramValue name="outputFile">$proteinsFile</paramValue>
      <depends step="calcTranslatedProteins"/>
    </step>

    <step name="blastx" subflow="">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="subjectFile">$$$nrdbFile</paramValue>
      <paramValue name="queryFile">$$$genomicSeqsFile</paramValue>
      <depends step="extractProteins"/>
      <depends step="extractGenomicSeqs"/>
    </step>

    <step name="psipred" subflow="psipred">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="nrdbFile">$$$nrdbFile</paramValue>
      <paramValue name="proteinsFile">$$$proteinsFile</paramValue>
      <depends step="extractProteins"/>
      <depends step="nrdb"/>
    </step>

    <step name="blastp" subflow="blast">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="subjectFile">$$$nrdbFile</paramValue>
      <paramValue name="queryFile">$$$proteinsFile</paramValue>
      <depends step="extractProteins"/>
      <depends step="nrdb"/>
    </step>

    <step name="molecularWeight"
          class="ApiCommonData::Load::Steps::CalculateProteinMolWt">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="molecularWeightMinMax"
          class="ApiCommonData::Load::Steps::InsertAASeqMWMinMax">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="isoelectricPoint"
          class="ApiCommonData::Load::Steps::InsertAAiP">
      <paramValue name="genomeName">$$$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="runTmhmm"
          class="ApiCommonData::Load::Steps::RunTmhmm">
      <paramValue name="seqFile">$proteinsFile</paramValue>
      <paramValue name="outputFile">tmhmm/${genomeName}Tmhmm.out</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="insertTmhmm"
          class="ApiCommonData::Load::Steps::InsertTmhmm">
      <paramValue name="inputFile">tmhmm/${genomeName}Tmhmm.out</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$$genomeExtDbRlsSpec</paramValue>
      <depends step="runTmhmm"/>
    </step>

  </steps>
</workflow>
