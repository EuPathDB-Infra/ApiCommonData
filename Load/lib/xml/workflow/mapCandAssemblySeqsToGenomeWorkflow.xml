<workflowGraph name="mapCandAssemblySeqsToGenome">

    <param name="genomeDataDir"/>
    <param name="genomeTaskLogsDir"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="parentNcbiTaxonId"/>
    <param name="NcbiTaxonId"/>
    <param name="predictedTranscriptsSql"/>
    <param name="genomeName"/>
    <param name="BLATQueryName"/>
    <param name="BLATTargetName"/>
    <param name="genomicSeqsFile"/>
    <param name="TranscriptSeqsFile"/>

    <step name="makeCandidateAssemblySeqs" class="ApiCommonData::Load::WorkflowSteps::MakeCandidateAssemblySeqs">
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="useTaxonHierarchy">true</paramValue>
      <paramValue name="predictedTranscriptsSql">$$predictedTranscriptsSql$$</paramValue>
    </step>

   <step name="extractCandidateAssemblySeqs"
          stepClass="ApiCommonData::Load::Steps::ExtractCandidateAssemblySeqs">
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="useTaxonHierarchy">true</paramValue>
      <paramValue name="outputFile">$$TranscriptSeqsFile$$</paramValue>
      <depends step="makeCandidateAssemblySeqs"/>
    </step>


    <step name="extractGenomicSeqsIntoSeparateFastaFiles"
          stepClass="ApiCommonData::Load::Steps::ExtractNaSeq">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="identifier">source_id</paramValue>
      <paramValue name="outputFileOrDir">$$genomeDataDir$$/seqfiles/$$genomeName$$-genome</paramValue>
      <paramValue name="separateFastaFiles">true</paramValue>
    </step>

    <step name="makeGfClientDataDir" class="ApiCommonData::Load::WorkflowSteps::MakeDir">
      <paramValue name="dataDir">$$genomeDataDir$$/candidateAssemblySeqs</paramValue>
    </step>

    <step name="makeGfClientClusterTaskInputDir" class="ApiCommonData::Load::WorkflowSteps::MakeGfClientInputDir">
      <paramValue name="taskInputDir">$$genomeDataDir$$/candidateAssemblySeqs/input</paramValue>
      <paramValue name="TranscriptSeqsFile">$$TranscriptSeqsFile$$</paramValue>
      <depends step="makeDataDir"/>
    </step>

    <step name="mirrorGfClientToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="parentDir">$$genomeDataDir$$</paramValue>
      <paramValue name="fileOrDirToMirror">candidateAssemblySeqs</paramValue>
      <depends step="makeClusterTaskDir"/>
    </step>

    <step name="makeRepeatMaskDataDir" class="ApiCommonData::Load::WorkflowSteps::MakeDir">
      <paramValue name="dataDir">$$genomeDataDir$$/candidateAssemblySeqsRepeatMask</paramValue>
    </step>

    <step name="makeRepeatMaskClusterTaskInputDir" class="ApiCommonData::Load::WorkflowSteps::MakeRepeatMaskTaskInputDir">
      <paramValue name="taskInputDir">$$genomeDataDir$$/candidateAssemblySeqs/input</paramValue>
      <paramValue name="TranscriptSeqsFile">$$TranscriptSeqsFile$$</paramValue>
      <depends step="makeDataDir"/>
    </step>


    <step name="mirrorRepeatMaskToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="parentDir">$$genomeDataDir$$</paramValue>
      <paramValue name="fileOrDirToMirror">candidateAssemblySeqs</paramValue>
      <depends step="makeClusterTaskDir"/>
    </step>

    <step name="startClusterTask" class="ApiCommonData::Load::WorkflowSteps::StartClusterTask">
      <paramValue name="taskDir">$$genomeDataDir$$/candidateAssemblySeqs</paramValue>
      <paramValue name="taskLogsDir">$$genomeTaskLogsDir$$/candidateAssemblySeqs</paramValue>
      <paramValue name="queue">apidb</paramValue>
      <paramValue name="cmdName">runGenomeAlignWithGfClient</paramValue>
      <paramValue name="cmdArgs">$$TranscriptSeqsFile$$,$$genomicSeqsFile$$</paramValue>
      <depends step="mirrorToCluster"/>
    </step>

    <step name="waitForClusterTask" waitForPilot="yes">
      <paramValue name="descrip">candidateAssemblySeqs</paramValue>
      <depends step="startClusterTask"/>
    </step>

    <step name="mirrorGfClientFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="parentDir">$$genomeDataDir$$/candidateAssemblySeqs</paramValue>
      <paramValue name="fileOrDirToMirror">master</paramValue>
      <depends step="waitForClusterTask"/>
    </step>

    <step name="mirrorRepeatMaskFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="parentDir">$$genomeDataDir$$/candidateAssemblySeqs</paramValue>
      <paramValue name="fileOrDirToMirror">master</paramValue>
      <depends step="waitForClusterTask"/>
    </step>

 
    <step name="updateGusTableWithXml" class="ApiCommonData::Load::WorkflowSteps::UpdateGusTableWithXml">
      <paramValue name="xmlFile">$$PROJECT_HOME$$/ApiCommonData/Load/config/blatalignmentquality.xml</paramValue>
      <paramValue name="gusTable">BlatAlignmentQuality</paramValue>

    </step>

    <step name="insertBLATAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBLATAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="BLATQueryName">$$BLATQueryName$$</paramValue>
      <paramValue name="BLATTargetName">$$BLATTargetName$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="BLATFile">$$genomeDataDir$$/candidateAssemblySeqs/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$genomeDataDir$$/candidateAssemblySeqs/master/mainresult/blocked.seq</paramValue>
      <depends step="mirrorRepeatMaskFromCluster"/>
      <depends step="mirrorGfClientFromCluster"/>
      <depends step="updateGusTableWithXml"/>
    </step>

    <step name="setbestBLATAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBLATAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="BLATQueryName">$$BLATQueryName$$</paramValue>
      <paramValue name="BLATTargetName">$$BLATTargetName$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="BLATFile">$$genomeDataDir$$/candidateAssemblySeqs/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$genomeDataDir$$/candidateAssemblySeqs/master/mainresult/blocked.seq</paramValue>
      <depends step="insertBLATAlignment"/>
    </step>

</workflowGraph>
