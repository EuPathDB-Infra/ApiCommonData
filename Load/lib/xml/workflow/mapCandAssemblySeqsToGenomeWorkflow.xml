<workflowGraph name="mapCandAssemblySeqsToGenome">

    <param name="parentDataDir"/>
    <param name="organismTaskLogsDir"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="ncbiTaxonId"/>
    <param name="candSeqsDataDir"/>

    <constant name="dataDir">$$candSeqsDataDir$$</constant>

    <step name="makeDataDir" class="ApiCommonData::Load::WorkflowSteps::MakeDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="extractGenomicSeqsIntoSeparateFastaFiles"
          stepClass="ApiCommonData::Load::Steps::ExtractNaSeq">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="identifier">source_id</paramValue>
      <paramValue name="outputFile"></paramValue>
      <paramValue name="separateFastaFiles">true</paramValue>
      <paramValue name="outputDirForSeparateFiles">$$dataDir$$/genomeFiles</paramValue>
      <depends step="makeAssemblyCandGfClientDataDir"/>
    </step>

    <step name="makeTaskInputDir" class="ApiCommonData::Load::WorkflowSteps::MakeGfClientInputDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <depends step="makeAssemblyCandGfClientDataDir"/>

    </step>

    <step name="mirrorGfClientToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="parentDir">$$parentDataDir$$</paramValue>
      <paramValue name="fileOrDirToMirror">assemblyCandGfClient</paramValue>
      <depends step="makeGfClientClusterTaskInputDir"/>
      <depends step="extractGenomicSeqsIntoSeparateFastaFiles"/>
    </step>

    <step name="startClusterTask" class="ApiCommonData::Load::WorkflowSteps::StartClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <paramValue name="taskLogsDir">$$genomeTaskLogsDir$$/candidateAssemblySeqs</paramValue>
      <paramValue name="queue">apidb</paramValue>
      <paramValue name="cmdName">runGenomeAlignWithGfClient</paramValue>
      <paramValue name="cmdArgs">???</paramValue>
      <depends step="mirrorGfClientToCluster"/>
      <depends step="mirrorCandidateRepeatMaskToCluster"/>
    </step>

    <step name="waitForClusterTask" waitForPilot="yes">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <depends step="startClusterTask"/>
    </step>

    <step name="mirrorFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="parentDir">$$dataDir$$</paramValue>
      <paramValue name="fileOrDirToMirror">master</paramValue>
      <depends step="waitForClusterTask"/>
    </step>

    <step name="InsertGusTableWithXml" class="ApiCommonData::Load::WorkflowSteps::InsertGusTableWithXml">
      <paramValue name="xmlFile">$$PROJECT_HOME$$/ApiCommonData/Load/config/blatalignmentquality.xml</paramValue>
      <paramValue name="gusTable">BlatAlignmentQuality</paramValue>

    </step>

    <step name="insertBlatAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBlatAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$candSeqsDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends step="mirrorRepeatMaskFromCluster"/>
      <depends step="mirrorGfClientFromCluster"/>
      <depends step="InsertGusTableWithXml"/>
    </step>

    <step name="setBestBlatAlignment" class="ApiCommonData::Load::WorkflowSteps::InsertBlatAlignment">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$candSeqsDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends step="insertBlatAlignment"/>
    </step>

</workflowGraph>
