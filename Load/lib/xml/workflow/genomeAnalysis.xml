<workflowGraph name="genomeAnalysis">

  <param name="parentDataDir"/>
  <param name="organismName"/>
  <param name="genomeExtDb"/>
  <param name="genomeExtDbRls"/>
  <param name="genomeVirtualSeqExtDb"/>
  <param name="genomeVirtualSeqExtDbRls"/>
  <param name="tigrVersion"/>
  <param name="ncbiTaxonVersion"/>
  <param name="soVersion"/>
  <param name="ncbiTaxonId"/>
  <param name="parentNcbiTaxonId"/>
  <param name="predictedTranscriptsSql"/>
  <param name="nrdbFile"/>
  <param name="nrdbShortDeflineFile"/>
  <param name="maxIntronSize"/>
  <param name="taxonHierarchyForBlastxFilter"/>
  <param name="runSplign"/>
  <param name="nrdbExtDbRlsSpec"/>
  <param name="organismTwoLetterAbbrev"/>

  <constant name="dataDir">$$parentDataDir$$/genome</constant>
  <constant name="genomeExtDbRlsSpec">$$genomeExtDb$$|$$genomeExtDbRls$$</constant>
  <constant name="genomeVirtualSeqsExtDbRlsSpec">$$genomeVirtualSeqsExtDb$$|$$genomeVirtualSeqsExtDbRls$$</constant>
  <constant name="genomicSeqsFile">$$dataDir$$/genomicSeqs.fsa</constant>
  <constant name="assemblySeqsDataDir">$$dataDir$$/makeAssemblySeqs</constant>
  <constant name="mapAssemblySeqsDataDir">$$dataDir$$/mapAssemblySeqs</constant>
  <constant name="assembliesDataDir">$$dataDir$$/makeAssemblies</constant>
  <constant name="virtualSeqsDataDir">$$dataDir$$/mixedGenomicSeqs</constant>

  <step name="makeDataDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$</paramValue>
  </step>

  <subgraph name="splign" xmlFile="splignWorkflow.xml" includeIf="$$runSplign$$">
    <paramValue name="parentDataDir">$$dataDir$$</paramValue>
    <paramValue name="queryExtDbRlsSpec">tigr:$$tigrVersion$$</paramValue>
    <paramValue name="subjectExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>   
    <depends name="makeDataDir"/> 
  </subgraph>

  <step name="extractGenomicSeqs"
          stepClass="ApiCommonData::Load::Steps::ExtractNaSeqs">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="alternateDefline"></paramValue>
      <paramValue name="outputFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="separateFastaFiles">false</paramValue>
      <paramValue name="outputDirForSeparateFiles"></paramValue>
      <depends name="makeDataDir"/> 
    </step>

    <subgraph name="dumpAndBlockMixedGenomicSeqs" xmlFile="dumpAndBlockMixedGenomicSeqs.xml">
      <paramValue name="dataDir">$$virtualSeqsDataDir$$</paramValue>
      <paramValue name="genomeVirtualSeqsExtDbRlsSpec">$$genomeVirtualSeqsExtDbRlsSpec$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends name="makeDataDir"/> 
    </subgraph>

   <step name="mirrorToCluster" stepClass="ApiCommonData::Load::Steps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">genome</paramValue>
      <paramValue name="parentDir">$$parentDir$$</paramValue>
      <depends name="extractGenomicSeqs"/>
    </step>

    <subgraph name="blastxGenomicSeqsNrdb" xmlFile="blastWorkflow.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="nickName">blastxNrdb</paramValue>
      <paramValue name="queryFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="queryTable">Dots.ExternalNaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectFile">$$nrdbShortDeflineFile$$</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec">$$nrdbExtDbRlsSpec$$</paramValue>
      <paramValue name="blastArgs">-cpus=4 -topcomboN=1 W=4 T=18 V=100 B=1000000 -hspmax=1000000 -gi E=1e-3 -wordmask=seg+xnu -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastx</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <paramValue name="filterByTaxon">true</paramValue>
      <paramValue name="taxonHierarchyForFilter">$$taxonHierarchyForBlastxFilter$$</paramValue>
      <paramValue name="loadOptions"></paramValue>
      <depends name="mirrorToCluster"/>
    </subgraph>

    <step name="makeOrfFile"
          stepClass="ApiCommonData::Load::Steps::MakeOrfFile">
      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="minPepLength">50</paramValue>
      <paramValue name="outputFile">$$dataDir$$/Orf50.gff</paramValue>
      <depends name="extractGenomicSeqs"/>
    </step>

    <step name="loadOrfFile"
          stepClass="ApiCommonData::Load::Steps::InsertOrfFile">
      <paramValue name="inputFile">$$dataDir$$/Orf50.gff</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="substepClass">ExternalNASequence</paramValue>
      <paramValue name="defaultOrg">$$organismName$$</paramValue>
      <paramValue name="isfMappingFileRelToGusHome">lib/xml/orf2gus.xml</paramValue>
      <paramValue name="soVersion">$$soVersion$$</paramValue>
      <depends name="makeOrfFile"/>
    </step>

    <step name="findTandemRepeats"
          stepClass="ApiCommonData::Load::Steps::FindTandemRepeats">
      <paramValue name="seqsFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="repeatFinderArgs">2 7 7 80 20 50 500</paramValue>
      <paramValue name="outputFile">$$dataDir$$/tandemRepeats.out</paramValue>
      <depends name="extractGenomicSeqs"/>
    </step>

    <step name="loadTandemRepeats"
          stepClass="ApiCommonData::Load::Steps::InsertTandemRepeats">
      <paramValue name="inputFile">$$dataDir$$/tandemRepeats.out</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <depends name="findTandemRepeats"/>
    </step>

   <step name="runLowComplexityFilter"
          stepClass="ApiCommonData::Load::Steps::RunLowComplexityFilter">

      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="outputFile">$$genomicSeqsFile$$.dust</paramValue>
      <paramValue name="filterType">dust</paramValue>
      <paramValue name="options"></paramValue>
      <depends name="extractGenomicSeqs"/>
    </step>

    <step name="loadLowComplexityFile"
          stepClass="ApiCommonData::Load::Steps::InsertLowComplexitySequences">
      <paramValue name="inputFile">$$genomicSeqsFile$$.dust</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="seqType">dna</paramValue>
      <paramValue name="mask">N</paramValue> 
      <paramValue name="options">--LowComplexityName 'dust'</paramValue>
      <depends name="runLowComplexityFilter"/>
    </step>

    <subgraph name="makeAndBlockAssemblySeqs" xmlFile="makeAndBlockAssemblySeqs.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="predictedTranscriptsSql">$$predictedTranscriptsSql$$</paramValue>
      <paramValue name="dataDir">$$assemblySeqsDataDir$$</paramValue>
      <depends name="extractGenomicSeqs"/>
    </subgraph>

    <subgraph name="mapAssemblySeqsToGenome" xmlFile="mapAssemblySeqsToGenome.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="assemblySeqsDataDir">$$assemblySeqsDataDir$$</paramValue>
      <paramValue name="dataDir">$$mapAssemblySeqsDataDir$$</paramValue>
      <paramValue name="genomicSeqsDir">$$mapAssemblySeqsDataDir$$/genomicSeqs</paramValue>
      <depends name="makeAndBlockAssemblySeqs"/>
    </subgraph>

    <subgraph name="makeAndBlockAssemblies" xmlFile="makeAndBlockAssemblies.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="dataDir">$$assembliesDataDir$$</paramValue>
      <paramValue name="assemblySeqsDataDir">$$assemblySeqsDataDir$$</paramValue>
      <depends name="mapAssemblySeqsToGenome"/>
    </subgraph>

    <subgraph name="mapAssembliesToGenome" xmlFile="mapAssembliesToGenome.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="assembliesDataDir">$$assembliesDataDir$$</paramValue>
      <paramValue name="genomicSeqsDir">$$mapAssemblySeqsDataDir$$/genomicSeqs</paramValue>
      <paramValue name="organismTwoLetterAbbrev">$$organismTwoLetterAbbrev$$</paramValue>
      <depends name="makeAndBlockAssemblies"/>
    </subgraph>

</workflowGraph>
