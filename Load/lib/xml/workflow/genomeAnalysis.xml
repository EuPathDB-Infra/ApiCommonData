<workflowGraph name="standardGenomeAnalysis">

  <param name="parentDataDir"/>
  <param name="organismTaskLogsDir"/>
  <param name="genomeExtDb"/>
  <param name="genomeExtDbRls"/>
  <param name="tigrVersion"/>
  <param name="ncbiTaxonVersion"/>
  <param name="ncbiTaxonId"/>
  <param name="maxIntronSize"/>
  <param name="taxonHierarchyForBlastxFilter"/>

  <!-- organism names -->
  <constant name="Tbrucei">Trypanosoma brucei TREU927</constant>

  <!-- handles on external datasets -->
  <constant name="genomeExtDbRlsSpec">$$genomeExtDb$$:$$genomeExtDbRls$$</constant>
  <constant name="nrdbFile">seqfiles/nr.fsa</constant>
  <constant name="nrdbExtDbRlsSpec">NRDB:$$nrdbVersion$$</constant>
  <constant name="nrdbShortDeflineFile">seqfiles/nrShortDefline.fsa</constant>
  <constant name="genomicSeqsFile">genomicSeqs.fsa</constant>
  <constant name="organismDataDir">data/$$organismName$$</constant>
  <constant name="organismTaskLogsDir">taskLogs/$$organismName$$</constant>
  <constant name="proteinsFile">$$organismDataDir$$/seqfiles/AnnotatedProteins.fsa</constant>

  <subgraph name="splign" xmlFile="splignWorkflow.xml">
    <include match="$organismName" list="$Pf,$Pb,$Py,$Pv"/>
    <paramValue name="queryExtDbRlsSpec">tigr:$$tigrVersion$$</paramValue>
    <paramValue name="subjectExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>      <paramValue name="organismDataDir">$$organismDataDir$$</paramValue>
  </subgraph>

  <step name="extractGenomicSeqs"
          stepClass="ApiCommonData::Load::Steps::ExtractNaSeq">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="identifier">source_id</paramValue>
      <paramValue name="outputFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="separateFastaFiles">false</paramValue>
      <paramValue name="outputDirForSeparateFiles"></paramValue>
    </step>

   <step name="mirrorGenomicSeqsToCluster" class="ApiCommonData::Load::Steps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$genomicSeqsFile$$</paramValue>
      <paramValue name="parentDir">$$organismDataDir$$</paramValue>
      <depends step="extractGenomicSeqs"/>
    </step>

    <subgraph name="blastxGenomicSeqsNrdb" xmlFile="blastWorkflow.xml">
      <paramValue name="organismDataDir">$$organismDataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir">$$organismTaskLogsDir$$</paramValue>
      <paramValue name="queryFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="queryTable">Dots.ExternalNaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectFile">$$nrdbShortDeflineFile$$</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec"></paramValue>
      <paramValue name="blastArgs">-cpus=4 -topcomboN=1 W=4 T=18 V=100 B=1000000 -hspmax=1000000 -gi E=1e-3 -wordmask=seg+xnu -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastx</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <paramValue name="filterByTaxon">true</paramValue>
      <paramValue name="taxonHierarchyForFilter">$$taxonHierarchyForBlastxFilter$$</paramValue>
      <paramValue name="loadOptions"></paramValue>
      <depends step="extractProteins"/></paramValue>
      <depends step="extractGenomicSeqs"/></paramValue>
    </subgraph>

    <step name="makeOrfFile"
          stepClass="ApiCommonData::Load::Steps::MakeOrfFile">
      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="minPepLength">50</paramValue>
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="outputFile">$$organismName$$_Orf50.gff</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends step="extractGenomicSeqs"/>
    </step>

    <step name="loadOrfFile"
          stepClass="ApiCommonData::Load::Steps::LoadOrfFile">
      <paramValue name="orfFile">$$organismName$$_Orf50.gff</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="subclass">ExternalNASequence</paramValue>
      <paramValue name="defaultOrg">$$Tbrucei$$</paramValue>
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends step="makeOrfFile"/>
    </step>

    <step name="findTandemRepeats"
          stepClass="ApiCommonData::Load::Steps::FindTandemRepeats">
      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="repeatFinderArgs">2 7 7 80 20 50 500</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends step="extractGenomicSeqs"/>
    </step>

    <step name="loadTandemRepeats"
          stepClass="ApiCommonData::Load::Steps::LoadTandemRepeats">
      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="repeatFinderArgs">2 7 7 80 20 50 500</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends step="makeOrfFile"/>
    </step>

    <step name="filterGenomicSeqs"
          stepClass="ApiCommonData::Load::Steps::FilterSequences">
      <paramValue name="seqFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="outputFile">$$genomicSeqsFile$$.dust</paramValue>
      <paramValue name="filterDir">filter</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <paramValue name="filterType">dust</paramValue>
      <paramValue name="opt">-x</paramValue>
      <depends step="extractGenomicSeqs"/>
    </step>


     <step name="loadLowComplexityGenomicSeqs"
          stepClass="ApiCommonData::Load::Steps::LoadLowComplexitySequences">
      <paramValue name="seqfilesDir">$$seqfilesDir$$</paramValue>
      <paramValue name="inputFile">$$genomicSeqsFile$$.dust</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <paramValue name="seqType">dna</paramValue>
      <paramValue name="mask">N</paramValue> 
      <paramValue name="opt">--LowComplexityName 'dust'</paramValue>
      <depends step="filterGenomicSeqs"/>
    </step>


    <subgraph name="makeAndBlockCandAssemblySeqs" xmlFile="makeAndBlockCandAssemblySeqs.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir"$$organismTaskLogsDir$$></paramValue>
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="predictedTranscriptsSql">$$predictedTranscriptsSql$$</paramValue>
      <paramValue name="dataDir">$$dataDir$$/makeCandidateAssemSeqs</paramValue>
      <depends step="extractGenomicSeqs"/>
    </subgraph>

    <subgraph name="mapCandAssemblySeqsToGenome" xmlFile="mapCandAssemblySeqsToGenomeWorkflow.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir"$$organismTaskLogsDir$$></paramValue>
      <paramValue name="genomeExtDbRlsSpec"$$genomeExtDbRlsSpec$$></paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="blatQueryName">transcriptSeqs</paramValue>
      <paramValue name="blatTargetName">genome</paramValue>
      <paramValue name="candSeqsDataDir">$$dataDir$$/makeCandidateAssemSeqs</paramValue>
      <depends step="extractGenomicSeqs"/>
    </subgraph>

    <subgraph name="assembleTranscriptsandMapAssemblySeqsToGenome" xmlFile="mapDotsAssemblyToGenomeWorkflow.xml">
      <paramValue name="organismDataDir">$$genomeDataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir"$$$genomeTaskLogsDir$></paramValue>
      <paramValue name="genomeExtDbRlsSpec"$$genomeExtDbRlsSpec$$></paramValue>
      <paramValue name="parentNcbiTaxonId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="BLATQueryName">$$organismName$$TranscriptSeqs</paramValue>
      <paramValue name="BLATTargetName">$$organismName$$Genome</paramValue>
      <paramValue name="transcriptRepeatMaskFile">$$organismDataDir$$/candidateAssemblySeqsRepeatMask/master/mainresults/block.err</paramValue>
      <depends step="mapCandAssemblySeqsToGenome"/>
    </subgraph>


</workflowGraph>
