<workflow name="psipred">
  <params>
    <param name="genomeName"/>
    <param name="nrdbFile"/>
    <param name="proteinsFile"/>
   </param>

  <constants>
    <constant name="psipredProteinsFile">seqfiles/psipred${genomeName}Proteins.fsa</constant>
    <constant name="algName">Psipred</constant>
    <constant name="algDesc">Psipred method for protein secondary structure prediction</constant>
    <constant name="algImpVer">2.5</constant>
    <constant name="algResult">Secondary Structure prediction for all $genomeName annotated proteins</constant>
  </constants>

  <steps>

    <step name="createDataDir" class="ApiCommonData::Load::Steps::CreatePsipredDirWithFormattedDb">
      <paramValue name="nrdbFile"></paramValue>
    </step>


    <step name="fixProteinIds" class="ApiCommonData::Load::Steps::FixProteinIdsForPsipred">
      <paramValue name="inputProteinsFile">$$$proteinsFile</paramValue>
      <paramValue name="outputProteinsFile">$$$psipredProteinsFile</paramValue>
      <depends step="createDataDir"/>
    </step>


    <step name="createTaskDir" class="ApiCommonData::Load::Steps::CreatePsipredTaskDir">
      <paramValue name="proteinsFile">$$$psipredProteinsFile</paramValue>
      <paramValue name="nrdbFile">$$$nrdbFile</paramValue>
      <depends step="fixProteinIds"/>
    </step>

    <step name="copyDataDirToCluster" class="ApiCommonData::Load::Steps::CopyFilesToComputeCluster">
      <paramValue name="file">psipred</paramValue>
      <depends step="createTaskDir"/>
    </step>

    <step name="copyProteinFileToCluster" class="ApiCommonData::Load::Steps::CopyFilesToComputeCluster">
      <paramValue name="file">$$$psipredProteinsFile</paramValue>
      <paramValue name="dir">seqfiles</paramValue>
      <depends step="copyDataDirToCluster"/>
    </step>

    <step name="startPsipredOnCluster" class="ApiCommonData::Load::Steps::StartPsipredOnComputeCluster">
      <paramValue name=""></paramValue>
      <paramValue name="query">$$$psipredProteinsFile</paramValue>
      <paramValue name="subject">$$$nrdbFile</paramValue>
      <depends step="copyProteinFileToCluster"/>
    </step>

    <step name="waitForCluster" waitForPilot="yes">
      <paramValue name="descrip">psipred $psipredProteinsFile $nrdbFile</paramValue>
      <depends step="startPsipredOnCluster"/>
    </step>

    <step name="copyFilesFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="file">${psipredProteinsFile}-${nrdbFile}</paramValue>
      <paramValue name="dir">psipred</paramValue>
      <depends step="waitForCluster"/>
    </step>

    <step name="fixFileNames" class="ApiCommonData::Load::Steps::FixPsipredFileNames">
      <paramValue name="dir">${psipredProteinsFile}-${nrdbFile}</paramValue>
      <depends step="copyFilesFromCluster"/>
     </step>

    <step name="makeAlgInv" class="ApiCommonData::Load::Steps::MakeAlgInv">
      <paramValue name="algName">$algName</paramValue>
      <paramValue name="algDesc">$algDesc</paramValue>
      <paramValue name="algResult">$algResult</paramValue>
      <depends step="fixFileNames"/>
    </step>

    <step name="insertPsipred" class="ApiCommonData::Load::Steps::LoadSecondaryStructures">
      <paramValue name="algName">$algName</paramValue>
      <paramValue name="dir"></paramValue>
      <paramValue name="algResult">$algResult</paramValue>
      <depends step="makeAlgInv"/>
    </step>

 </steps>

</workflow>
