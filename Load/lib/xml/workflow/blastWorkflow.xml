<workflowGraph name="blastWorkflow">
    <param name="parentDataDir"/>
    <param name="nickName"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbRlsSpec"/>
    <param name="subjectFile"/>
    <param name="subjectTable"/>
    <param name="subjectExtDbRlsSpec"/>
    <param name="blastArgs"/>
    <param name="idRegex"/>
    <param name="blastType"/>
    <param name="vendor"/>
    <param name="loadSubjectSubset"/>
    <param name="filterByTaxon"/>
    <param name="taxonHierarchyForFilter"/>
    <param name="loadOptions"/>

    <constant name="dataDir">$$parentDataDir$$/$$nickName$$</constant>

    <step name="makeDataDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeClusterTaskDir" stepClass="ApiCommonData::Load::Steps::MakeBlastTaskInputDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="subjectFile">$$subjectFile$$</paramValue>
      <paramValue name="blastArgs">$$blastArgs$$</paramValue>
      <paramValue name="idRegex">$$idRegex$$</paramValue>
      <paramValue name="blastType">$$blastType$$</paramValue>
      <paramValue name="vendor">$$vendor$$</paramValue>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonData::Load::WorkflowSteps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/$$nickName$$</paramValue>
      <depends name="makeClusterTaskDir"/>
    </step>

    <step name="startClusterTask" stepClass="ApiCommonData::Load::WorkflowSteps::StartClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <paramValue name="queue">apidb</paramValue>
      <paramValue name="cmdName">runBlastSimilarities</paramValue>
      <paramValue name="cmdArgs">$$queryFile$$ $$subjectFile$$</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="waitForClusterTask" stepClass="ApiCommonData::Load::WorkflowSteps::WaitForClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <depends name="startClusterTask"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ApiCommonData::Load::Steps::MirrorFromComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <depends name="waitForClusterTask"/>
    </step>

    <step name="filterResultsByTaxon" stepClass="ApiCommonData::Load::Steps::FilterBlastResultsByTaxon" includeIf="$$filterByTaxon$$">
      <paramValue name="taxonHierarchy">$$taxonHierarchyForFilter$$</paramValue>
      <paramValue name="gi2taxidFileRelativeToDownloadDir">taxonomy/gi_taxid_prot.dmp</paramValue>
      <paramValue name="inputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <paramValue name="unfilteredOutputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.orig.gz</paramValue>
      <paramValue name="filteredOutputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <depends name="mirrorFromCluster"/>
     </step>

    <step name="extractIdsFromBlastResult" stepClass="ApiCommonData::Load::Steps::ExtractIdsFromBlastResult" includeIf="$$loadSubjectSubset$$">
      <paramValue name="inputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <paramValue name="idType">subject</paramValue>
      <paramValue name="outputFile">$$dataDir$$/blastSimIds.out</paramValue>
      <depends name="mirrorFromCluster"/>
     </step>

    <step name="loadSubjectSubset" stepClass="ApiCommonData::Load::Steps::InsertFastaSubset" includeIf="$$loadSubjectSubset$$">
      <paramValue name="extDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="fastaFile">common/nrdb.fsa</paramValue>
      <paramValue name="idsFile">$$dataDir$
$/blastSimIds.out</paramValue>
      <paramValue name="nrdbExtDbRlsSpec">$$nrdbExtDbRlsSpec$$</paramValue>
      <depends name="extractIdsFromBlastResult"/>
    </step>

    <step name="loadSimilarities" stepClass="ApiCommonData::Load::Steps::InsertBlastSimilarities">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/blastSimilarity.out.gz</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryTableIdCol">source_id</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$queryExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectTable">$$subjectTable$$</paramValue>
      <paramValue name="subjectTableIdCol">source_id</paramValue>
      <paramValue name="subjectExtDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="options">$$loadOptions$$</paramValue>
      <depends name="loadSubjectSubset"/>
    </step>

</workflowGraph>
