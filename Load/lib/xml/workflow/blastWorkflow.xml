<workflowGraph name="blastWorkflow">
    <param name="parentDataDir"/>
    <param name="nickName"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbRlsSpec"/>
    <param name="subjectFile"/>
    <param name="subjectTable"/>
    <param name="subjectExtDbRlsSpec"/>
    <param name="blastArgs"/>
    <param name="idRegex"/>
    <param name="blastType"/>
    <param name="vendor"/>
    <param name="loadSubjectSubset"/>
    <param name="filterByTaxon"/>
    <param name="taxonHierarchyForFilter"/>
    <param name="loadOptions"/>

    <constant name="dataDir">$$parentDataDir$$/$$nickName$$</constant>

    <step name="makeDataDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeClusterTaskInputDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeBlastTaskInputDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="subjectFile">$$subjectFile$$</paramValue>
      <paramValue name="blastArgs">$$blastArgs$$</paramValue>
      <paramValue name="idRegex">$$idRegex$$</paramValue>
      <paramValue name="blastType">$$blastType$$</paramValue>
      <paramValue name="vendor">$$vendor$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonData::Load::WorkflowSteps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeClusterTaskInputDir"/>
    </step>

    <step name="runClusterTask" stepClass="ApiCommonData::Load::WorkflowSteps::RunAndMonitorClusterTask" stepLoadTypes="cluster">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="numNodes">20</paramValue>
      <paramValue name="processorsPerNode">4</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ApiCommonData::Load::WorkflowSteps::MirrorFromComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
      <paramValue name="outputFiles">blastSimilarity.out</paramValue>
      <depends name="runClusterTask"/>
    </step>

    <step name="filterResultsByTaxon" stepClass="ApiCommonData::Load::WorkflowSteps::FilterBlastResultsByTaxon" includeIf="$$filterByTaxon$$">
      <paramValue name="taxonHierarchy">$$taxonHierarchyForFilter$$</paramValue>
      <paramValue name="gi2taxidFileRelativeToDownloadDir">taxonomy/gi_taxid_prot.dmp</paramValue>
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/blastSimilarity.out</paramValue>
      <paramValue name="unfilteredOutputFile">$$dataDir$$/master/mainresult/blastSimilarity.out.orig</paramValue>
      <paramValue name="filteredOutputFile">$$dataDir$$/master/mainresult/blastSimilarity.out</paramValue>
      <depends name="mirrorFromCluster"/>
     </step>

    <step name="extractIdsFromBlastResult" stepClass="ApiCommonData::Load::WorkflowSteps::ExtractIdsFromBlastResult" includeIf="$$loadSubjectSubset$$">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/blastSimilarity.out</paramValue>
      <paramValue name="idType">subject</paramValue>
      <paramValue name="outputFile">$$dataDir$$/blastSimIds.out</paramValue>
      <depends name="mirrorFromCluster"/>
     </step>

    <step name="loadSubjectSubset" stepClass="ApiCommonData::Load::WorkflowSteps::InsertFastaSubset" includeIf="$$loadSubjectSubset$$" stepLoadTypes="loadNrdbSubjectSubset">
      <paramValue name="extDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="fastaFile">$$subjectFile$$</paramValue>
      <paramValue name="idsFile">$$dataDir$$/blastSimIds.out</paramValue>
      <depends name="extractIdsFromBlastResult"/>
    </step>

    <step name="updateNrdbTaxonIdField"
          stepClass="ApiCommonData::Load::WorkflowSteps::UpdateTaxonIdField" includeIf="$$loadSubjectSubset$$" stepLoadTypes="loadNrdbSubjectSubset">
      <paramValue name="mappingFileRelativeToDownloadDir">taxonomy/gi_taxid_prot.dmp</paramValue>
      <paramValue name="sourceIdRegex">^(\\d+)</paramValue>
      <paramValue name="taxonRegex">--ncbiTaxIdRegex "^\d+\s(\d+)"</paramValue>
      <paramValue name="idSql">select source_id, aa_sequence_id from dots.externalaasequence</paramValue>
      <paramValue name="extDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="tableName">DoTS::ExternalAASequence</paramValue>
      <depends name="loadSubjectSubset"/>
    </step>

    <step name="loadSimilarities" stepClass="ApiCommonData::Load::WorkflowSteps::InsertBlastSimilarities">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/blastSimilarity.out</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryTableIdCol">source_id</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$queryExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectTable">$$subjectTable$$</paramValue>
      <paramValue name="subjectTableIdCol">source_id</paramValue>
      <paramValue name="subjectExtDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="options">$$loadOptions$$</paramValue>
      <depends name="loadSubjectSubset"/>
    </step>

</workflowGraph>
