<workflowGraph name="blast">
    <param name="parentDataDir"/>
    <param name="nickName"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbRlsSpec"/>
    <param name="subjectFile"/>
    <param name="subjectTable"/>
    <param name="subjectExtDbRlsSpec"/>
    <param name="blastArgs"/>
    <param name="idRegex"/>
    <param name="blastType"/>
    <param name="vendor"/>
    <param name="loadSubjectSubset"/>
    <param name="filterByTaxon"/>
    <param name="taxonHierarchyForFilter"/>
    <param name="loadOptions"/>

    <constant name="dataDir">$$parentDataDir$$/$$nickName$$</constant>

    <step name="makeDataDir" class="ApiCommonData::Load::WorkflowSteps::MakeDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeClusterTaskDir" class="ApiCommonData::Load::Steps::CreateSimilarityDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="subjectFile">$$subjectFile$$</paramValue>
      <paramValue name="blastArgs">$$blastArgs$$</paramValue>
      <paramValue name="idRegex">$$idRegex$$</paramValue>
      <paramValue name="blastType">$$blastType$$</paramValue>
      <paramValue name="vendor">$$vendor$$</paramValue>
    </step>

    <step name="mirrorToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/$$nickName$$</paramValue>
      <depends step="makeClusterTaskDir"/>
    </step>

    <step name="startClusterTask" class="ApiCommonData::Load::WorkflowSteps::StartClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <paramValue name="queue">apidb</paramValue>
      <paramValue name="cmdName">runBlastSimilarities</paramValue>
      <paramValue name="cmdArgs">$$queryFile$$ $$subjectFile$$</paramValue>
      <depends step="mirrorToCluster"/>
    </step>

    <step name="waitForClusterTask">
      <paramValue name="taskDir">$$dataDir$$</paramValue>
      <depends step="startClusterTask"/>
    </step>

    <step name="mirrorFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <depends step="waitForClusterTask"/>
    </step>

    <step name="filterResultsByTaxon" class="ApiCommonData::Load::Steps::FilterBlastResultsByTaxon" includeIf="$$filterByTaxon$$">
      <paramValue name="taxonHierarchy">$$taxonHierarchyForFilter$$</paramValue>
      <paramValue name="gi2taxidFileRelativeToDownloadDir">taxonomy/gi_taxid_prot.dmp</paramValue>
      <paramValue name="inputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <paramValue name="unfilteredOutputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.orig.gz</paramValue>
      <paramValue name="filteredOutputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <depends step="mirrorFromCluster"/>
     </step>

    <step name="extractIdsFromBlastResult" class="ApiCommonData::Load::Steps::ExtractIdsFromBlastResult" includeIf="$$loadSubjectSubset$$">
      <paramValue name="inputFile">$$dataDir$$/master/mainResult/blastSimilarity.out.gz</paramValue>
      <paramValue name="idType">subject</paramValue>
      <paramValue name="outputFile">$$dataDir$$/blastSimIds.out</paramValue>
      <depends step="mirrorFromCluster"/>
     </step>

    <step name="loadSubjectSubset" class="ApiCommonData::Load::Steps::LoadFastaSubset"> 
      <includeIf>$$loadSubjectSubset$$</includeIf>
      <paramValue name="extDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValue name="fastaFile">common/nrdb.fsa</paramValue>
      <paramValue name="idsFile">$$dataDir$$/blastSimIds.out</paramValue>
      <paramValue name="nrdbExtDbRlsSpec">$$nrdbExtDbRlsSpec$$</paramValue>
      <depends step="extractIdsFromBlastResult"/>
    </step>

    <step name="loadSimilarities" class="ApiCommonData::Load::Steps::LoadBlastSimilarities">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/blastSimilarity.out.gz</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryTableIdCol">source_id</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$queryExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectTable">$$subjectTable$$</paramValue>
      <paramValue name="subjectTableIdCol">source_id</paramValue>
      <paramValue name="subjectExtDbRlsSpec">$$subjectExtDbRlsSpec$$</paramValue>
      <paramValues name="options">$$loadOptions$$</paramValues>
      <depends step="loadSubjectSubset"/>
    </step>

 </steps>

</workflow>
