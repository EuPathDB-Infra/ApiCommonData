<workflow name="blast">
  <params>
    <param name="genomeName"/>
    <param name="queryAbbrev"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbRlsSpec"/>
    <param name="subjectAbbrev"/>
    <param name="subjectFile"/>
    <param name="subjectTable"/>
    <param name="subjectExtDbRlsSpec"/>
    <param name="blastArgs"/>
    <param name="idRegex"/>
    <param name="blastType"/>
    <param name="vendor"/>
    <param name="loadSubjectSubset"/>
   </param>

  <constants>
    <constant name="similarityDir">${$queryAbbrev}-${$subjectAbbrev}</constant>
  </constants>

  <steps>

    <step name="createSimilarityDir" class="ApiCommonData::Load::Steps::CreateSimilarityDir">
      <paramValue name="queryAbbrev">$queryAbbrev</paramValue>
      <paramValue name="subjectAbbrev">$subjectAbbrev</paramValue>
      <paramValue name="queryFile">$queryFile</paramValue>
      <paramValue name="subjectFile">$queryFile</paramValue>
      <paramValue name="blastArgs">$subjectFile</paramValue>
      <paramValue name="idRegex">$idRegex</paramValue>
      <paramValue name="blastType">$blastType</paramValue>
      <paramValue name="vendor">$vendor</paramValue>
    </step>


    <step name="copyDataDirToCluster" class="ApiCommonData::Load::Steps::CopyFilesToComputeCluster">
      <paramValue name="file">$similarityDir</paramValue>
      <paramValue name="dir">similarity</paramValue>
      <depends step="createSimilarityDir"/>
    </step>

    <step name="startBlastOnCluster" class="ApiCommonData::Load::Steps::StartProteinBlastOnComputeCluster">
      <paramValue name=""></paramValue>
      <paramValue name="queryAbbrev">$queryAbbrev</paramValue>
      <paramValue name="subjectAbbrev">$subjectAbbrev</paramValue>
      <paramValue name="queryFile">$queryFile</paramValue>
      <depends step="copyDataDirToCluster"/>
    </step>

    <step name="waitForCluster" waitForPilot="yes">
      <paramValue name="descrip">$blastType $queryAbbrev $subjectAbbrev</paramValue>
      <depends step="startBlastOnCluster"/>
    </step>

    <step name="copyDataDirFromCluster" class="ApiCommonData::Load::Steps::CopyFilesFromComputeCluster">
      <paramValue name="file">$similarityDir</paramValue>
      <paramValue name="dir">similarity</paramValue>
      <depends step="waitForCluster"/>
    </step>

    <step name="extractIdsFromBlastResult" class="ApiCommonData::Load::Steps::ExtractIdsFromBlastResult">
      <paramValue name="similarityDir">$similarityDir</paramValue>
      <paramValue name="idType">subject</paramValue>
      <paramValue name="outputFile">$similarityDir/blastSimIds.out</paramValue>
      <depends step="copyDataDirFromCluster"/>
     </step>

    <step name="loadSubjectSubset" class="ApiCommonData::Load::Steps::LoadFastaSubset">
      <skipIfNot>$loadSubjectSubset</skipIfNot>
      <paramValue name="extDbRlsSpec">$subjectExtDbRlsSpec</paramValue>
      <paramValue name="fastaFile">$subjectFile</paramValue>
      <paramValue name="idsFile">$similarityDir/blastSimIds.out</paramValue>
      <paramValue name="table">$subjectTable</paramValue>
      <depends step="extractIdsFromBlastResult"/>
    </step>

    <step name="loadSimilarities" class="ApiCommonData::Load::Steps::LoadBlastSimilarities">
      <paramValue name="inputFile">$similarityDir/master/mainresult/blastSimilarity.out</paramValue>
      <paramValue name="queryTable">$queryTable</paramValue>
      <paramValue name="queryTableIdCol">source_id</paramValue>
      <paramValue name="queryExtDbRlsSpec">$queryExtDbRlsSpec</paramValue>
      <paramValue name="subjectTable">$subjectTable</paramValue>
      <paramValue name="subjectTableIdCol">source_id</paramValue>
      <paramValue name="subjectExtDbRlsSpec">$subjectExtDbRlsSpec</paramValue>
      <depends step="loadSubjectSubset"/>
    </step>

 </steps>

</workflow>
