<workflowGraph name="standardGenomeAnalysis">
  <param name="organismTwoLetterAbbrev"/>
  <param name="organismDataDir"/>
  <param name="organismTaskLogsDir"/>
  <param name="genomeExtDb"/>
  <param name="genomeExtDbRls"/>
  <param name="interproVersion"/>
  <param name="iedbVersion"/>
  <param name="nrdbVersion"/>
  <param name="ncbiTaxonId"/>
  <param name="nrdbFile"/>
  <param name="nrdbShortDeflineFile"/>
  <param name="pdbFile"/>

  <!-- handles on external datasets -->
  <constant name="genomeExtDbRlsSpec">$$genomeExtDb$$:$$genomeExtDbRls$$</constant>
  <constant name="nrdbExtDbRlsSpec">NRDB:$$nrdbVersion$$</constant>
  <constant name="organismDataDir">data/$$organismName$$</constant>
  <constant name="organismTaskLogsDir">taskLogs/$$organismName$$</constant>
  <constant name="proteinsFile">$$organismDataDir$$/seqfiles/AnnotatedProteins.fsa</constant>

    <step name="calcTranslatedProteins"
          stepClass="ApiCommonData::Load::Steps::CalculateTranslatedProteinSequence">
      <include match="$$organismTwoLetterAbbrev$$" list="Pf,Pb,Py,Pv,Tb,Lm,Li,Lb"/>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="soExtDbRlsSpec">$$soExtDbRlsSpec$$</paramValue>
    </step>

    <step name="molecularWeight"
          stepClass="ApiCommonData::Load::Steps::CalculateProteinMolWt">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="calcTranslatedProteins"/>
    </step>

    <step name="molecularWeightMinMax"
          stepClass="ApiCommonData::Load::Steps::InsertAASeqMWMinMax">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="calcTranslatedProteins"/>
    </step>

    <step name="isoelectricPoint"
          stepClass="ApiCommonData::Load::Steps::InsertAAiP">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends step="calcTranslatedProteins"/>
    </step>

    <step name="extractProteins"
          stepClass="ApiCommonData::Load::Steps::ExtractAnnotatedProteinsBySpecies">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="outputFile">$$proteinsFile$$</paramValue>
      <depends step="calcTranslatedProteins"/>
    </step>

    <step name="runTmhmm"
          stepClass="ApiCommonData::Load::Steps::RunTmhmm">
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="outputFile">$$organismDataDir$$/tmhmm.out</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="insertTmhmm"
          stepClass="ApiCommonData::Load::Steps::InsertTmhmm">
      <paramValue name="inputFile">$$organismDataDir$$/tmhmm.out</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <depends step="runTmhmm"/>
    </step>

    <step name="runSignalP"
          stepClass="ApiCommonData::Load::Steps::RunSignalP">
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="outputFile">$$organismDataDir$$/signalP.out</paramValue>
      <paramValue name="options">-t euk -f short -m nn+hmm -q -trunc 70</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="insertSignalP"
          stepClass="ApiCommonData::Load::Steps::InsertSignalP">
      <paramValue name="inputFile">$$organismDataDir$$/signalP.out</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <depends step="runSignalP"/>
    </step>

    <subgraph name="mapEpitopesToProteins" xmlFile="epitopesWorkflow.xml">
      <paramValue name="proteinsFile">$proteinsFile</paramValue>
      <paramValue name="organismDataDir">$$organismDataDir$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="organismTwoLetterAbbrev">$$organismTwoLetterAbbrev$$</paramValue>
      <paramValue name="iedbExtDbRlsSpec">iedb:$$iedbVersion$$</paramValue>
      <depends step="extractProteins"/>
    </subgraph>

   <step name="runLowComplexityFilter"
          stepClass="ApiCommonData::Load::Steps::RunLowComplexityFilter">

      <paramValue name="seqFile">$$proteinsFile$$</paramValue>
      <paramValue name="outputFile">$$proteinsFile$$.seg</paramValue>
      <paramValue name="filterType">seg</paramValue>
      <paramValue name="options">-x</paramValue>
      <depends step="extractProteins"/>
    </step>

    <step name="loadLowComplexityFile"
          stepClass="ApiCommonData::Load::Steps::LoadLowComplexitySequences">
      <paramValue name="inputFile">$$proteinsFile$$.seg</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="seqType">protein</paramValue>
      <paramValue name="mask">x</paramValue> 
      <paramValue name="options"></paramValue>
      <depends step="runLowComplexityFilter"/>
    </step>

    <step name="findNrdbXrefs" class="ApiCommonData::Load::WorkflowSteps::FindNrdbXrefs">
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="nrdbFile">$$nrdbFile$$</paramValue>
      <paramValue name="proteinsFileRegex">^([\\w\\.]+)</paramValue>
      <paramValue name="nrdbFileRegex">^\\|\\d+\\|(?:emb|gb|dbj|ref|sp|pdb)\\|([\\w\\.]+)\\|</paramValue>
      <paramValue name="outputFile">$$organismDataDir$$/nrdbXrefs.txt</paramValue>
    </step>

    <step name="loadNrdbXrefs" class="ApiCommonData::Load::WorkflowSteps::LoadNrdbXrefs">
      <paramValue name="xrefsFile">$$organismDataDir$$/nrdbXrefs.txt</paramValue>
      <paramValue name="dbAbbrevList">emb,gb,dbj,ref,sp,pdb</paramValue>
      <paramValue name="nrdbVersion">$$nrdbVersion$$</paramValue>
    </step>

    <step name="mirrorProteinsToCluster" class="ApiCommonData::Load::WorkflowSteps::MirrorToCluster">
      <paramValue name="parentDir">seqfiles</paramValue>
      <paramValue name="fileOrDirToMirror">AnnotatedProteins.fsa</paramValue>
      <depends step="extractProteins"/>
    </step>

    <subgraph name="interpro" xmlFile="interproWorkflow.xml">
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="organismDataDir">$$organismDataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir">$$organismTaskLogsDir$$</paramValue>
      <paramValue name="interproExtDbRlsSpec">interpro:$$interproVersion$$</paramValue>
      <paramValue name="interproVersion">$$interproVersion$$</paramValue>
    </subgraph>

    <subgraph name="psipred" xmlFile="psipredWorkflow.xml">
      <paramValue name="nrdbFile">$$nrdbShortDeflineFile$$</paramValue>
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="organismDataDir">$$organismDataDir$$</paramValue>
      <paramValue name="organismTaskLogsDir">$$organismTaskLogsDir$$</paramValue      <depends step="extractProteins"/>
      <depends step="nrdb"/>
    </subgraph>

    <subgraph name="blastpNrdb" xmlFile="blastWorkflow.xml">
      <paramValue name="organismName">$$organismName$$</paramValue>
      <paramValue name="queryAbbrev">proteins</paramValue>
      <paramValue name="queryFile">$$proteinsFile$$</paramValue>
      <paramValue name="queryTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectAbbrev">nrdb</paramValue>
      <paramValue name="subjectFile">$$nrdbFile$$</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec"></paramValue>
      <paramValue name="blastArgs">-cpus=2 -topcomboN=1 V=100 B=20 -hspmax=1000000 -gi E=1e-3 -wordmask=seg -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastp</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <depends step="extractProteins"/>
      <depends step="nrdb"/>
    </subgraph>

    <subgraph name="blastpPdb" xmlFile="blastWorkflow.xml">
      <paramValue name="organismName">$$organismName$$</paramValue>
      <paramValue name="queryAbbrev">proteins</paramValue>
      <paramValue name="queryFile">$$proteinsFile$$</paramValue>
      <paramValue name="queryTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="subjectAbbrev">nrdb</paramValue>
      <paramValue name="subjectFile">$$nrdbFile$$</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec"></paramValue>
      <paramValue name="blastArgs">-cpus=2 -topcomboN=1 V=100 B=20 -hspmax=1000000 -gi E=1e-3 -wordmask=seg -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastp</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <depends step="extractProteins"/>
      <depends step="nrdb"/>
    </subgraph>

</workflow>
